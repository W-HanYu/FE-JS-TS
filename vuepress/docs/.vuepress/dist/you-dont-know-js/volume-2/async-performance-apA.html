<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>附录A:*asynquence* 库 | </title><meta name="description" content="">
    <link rel="modulepreload" href="/assets/app.c62ce33e.js"><link rel="modulepreload" href="/assets/async-performance-apA.html.fc474119.js"><link rel="modulepreload" href="/assets/async-performance-apA.html.1318a5e9.js"><link rel="prefetch" href="/assets/1.1.hello-world.html.c9c3a5a1.js"><link rel="prefetch" href="/assets/1.10.if.html.9e1b96da.js"><link rel="prefetch" href="/assets/1.11.includes.html.f730fd82.js"><link rel="prefetch" href="/assets/1.12.parameters.html.cea6009c.js"><link rel="prefetch" href="/assets/1.13.push.html.b4a2eefb.js"><link rel="prefetch" href="/assets/1.14.unshift.html.899e4793.js"><link rel="prefetch" href="/assets/1.2.Pick.html.00955fc1.js"><link rel="prefetch" href="/assets/1.3.Awaited.html.c28eb4dc.js"><link rel="prefetch" href="/assets/1.4.Readonly.html.5504219f.js"><link rel="prefetch" href="/assets/1.5.Tuple-to-object.html.e5ff4876.js"><link rel="prefetch" href="/assets/1.6.First-of-array.html.8963da96.js"><link rel="prefetch" href="/assets/1.7.Length-of-Tuple.html.b566373d.js"><link rel="prefetch" href="/assets/1.8.concat.html.e48cdb0f.js"><link rel="prefetch" href="/assets/1.9.exclude.html.a9065b1a.js"><link rel="prefetch" href="/assets/2.1.Get-Return-Type.html.fc63429d.js"><link rel="prefetch" href="/assets/2.2.omit.html.12f10b17.js"><link rel="prefetch" href="/assets/2.3.Readonly2.html.e66ac73b.js"><link rel="prefetch" href="/assets/2.4.Deep-Readonly.html.a658e6e6.js"><link rel="prefetch" href="/assets/2.5.turn-to-union.html.073cd259.js"><link rel="prefetch" href="/assets/3.1.Simple-Vue.html.99882d01.js"><link rel="prefetch" href="/assets/donate.html.acbabecd.js"><link rel="prefetch" href="/assets/Routine1_pattern-matching-for-extraction.html.875abc65.js"><link rel="prefetch" href="/assets/basic-1.html.9eb41d9a.js"><link rel="prefetch" href="/assets/basic-2.html.f7caa9d2.js"><link rel="prefetch" href="/assets/basic-3.html.34aee1eb.js"><link rel="prefetch" href="/assets/http-2.html.787a8a96.js"><link rel="prefetch" href="/assets/http-3.html.34a30fe1.js"><link rel="prefetch" href="/assets/http-interview.html.ace5bf96.js"><link rel="prefetch" href="/assets/http-optimize.html.69d45db9.js"><link rel="prefetch" href="/assets/http-rpc.html.8491156f.js"><link rel="prefetch" href="/assets/http-websocket.html.7d4a1447.js"><link rel="prefetch" href="/assets/https-ecdhe.html.05368a85.js"><link rel="prefetch" href="/assets/https-optimize.html.6a75aeb7.js"><link rel="prefetch" href="/assets/https-rsa.html.f131cf25.js"><link rel="prefetch" href="/assets/ip-base.html.e6127d4e.js"><link rel="prefetch" href="/assets/ip-ping.html.6302a945.js"><link rel="prefetch" href="/assets/ip-ping_io.html.6c34496f.js"><link rel="prefetch" href="/assets/tcp-challenge-ack.html.3a5fc045.js"><link rel="prefetch" href="/assets/tcp-dump.html.b56080fb.js"><link rel="prefetch" href="/assets/tcp-feature.html.a3d828ae.js"><link rel="prefetch" href="/assets/tcp-interview.html.62d97690.js"><link rel="prefetch" href="/assets/tcp-isn-deff.html.82d20436.js"><link rel="prefetch" href="/assets/tcp-optimize.html.ca87f13b.js"><link rel="prefetch" href="/assets/tcp-out-of-order-fin.html.151c009d.js"><link rel="prefetch" href="/assets/tcp-queue.html.74d5129c.js"><link rel="prefetch" href="/assets/tcp-stream.html.e93bfa43.js"><link rel="prefetch" href="/assets/tcp-syn.html.d732a2c4.js"><link rel="prefetch" href="/assets/Advanced-1.html.fa0fc3db.js"><link rel="prefetch" href="/assets/Advanced-2.html.768f0222.js"><link rel="prefetch" href="/assets/Advanced-3.html.80ef5874.js"><link rel="prefetch" href="/assets/Advanced-4.html.9ac82786.js"><link rel="prefetch" href="/assets/Advanced-5.html.7086659b.js"><link rel="prefetch" href="/assets/base-1.html.a1a4a8f1.js"><link rel="prefetch" href="/assets/base-10.html.5a196727.js"><link rel="prefetch" href="/assets/base-11.html.aab11d1b.js"><link rel="prefetch" href="/assets/base-12.html.e5e162d6.js"><link rel="prefetch" href="/assets/base-13.html.e7f1ec06.js"><link rel="prefetch" href="/assets/base-14.html.7817c35c.js"><link rel="prefetch" href="/assets/base-15.html.234b3135.js"><link rel="prefetch" href="/assets/base-16.html.d8b75899.js"><link rel="prefetch" href="/assets/base-17.html.563cf78a.js"><link rel="prefetch" href="/assets/base-2.html.a766b26b.js"><link rel="prefetch" href="/assets/base-3.html.456ded6f.js"><link rel="prefetch" href="/assets/base-4.html.ad7f3656.js"><link rel="prefetch" href="/assets/base-5.html.d39095e5.js"><link rel="prefetch" href="/assets/base-6.html.b84ee494.js"><link rel="prefetch" href="/assets/base-7.html.178e9a4d.js"><link rel="prefetch" href="/assets/base-8.html.c0808088.js"><link rel="prefetch" href="/assets/base-9.html.208c7bb9.js"><link rel="prefetch" href="/assets/rollup-1.html.03002012.js"><link rel="prefetch" href="/assets/rollup-10.html.86a22541.js"><link rel="prefetch" href="/assets/rollup-11.html.e3a4642f.js"><link rel="prefetch" href="/assets/rollup-2.html.41d6ac3a.js"><link rel="prefetch" href="/assets/rollup-3.html.6ad17f68.js"><link rel="prefetch" href="/assets/rollup-4.html.7d4a4c3c.js"><link rel="prefetch" href="/assets/rollup-5.html.54596415.js"><link rel="prefetch" href="/assets/rollup-6.html.2de6134f.js"><link rel="prefetch" href="/assets/rollup-7.html.e1bb8ffd.js"><link rel="prefetch" href="/assets/rollup-8.html.1b8764c3.js"><link rel="prefetch" href="/assets/rollup-9.html.1d7bff01.js"><link rel="prefetch" href="/assets/scope-closures-appA.html.54460362.js"><link rel="prefetch" href="/assets/scope-closures-appB.html.df5a960f.js"><link rel="prefetch" href="/assets/scope-closures-appC.html.d19041c8.js"><link rel="prefetch" href="/assets/this-object-prototype-appA.html.a5e33133.js"><link rel="prefetch" href="/assets/async-performance-apB.html.6a42c749.js"><link rel="prefetch" href="/assets/async-performance-ch1.html.43644825.js"><link rel="prefetch" href="/assets/async-performance-ch2.html.5569a916.js"><link rel="prefetch" href="/assets/async-performance-ch3.html.6eb4b5e0.js"><link rel="prefetch" href="/assets/async-performance-ch4.html.b1839a56.js"><link rel="prefetch" href="/assets/async-performance-ch5.html.9bd4d678.js"><link rel="prefetch" href="/assets/async-performance-ch6.html.04dbdb45.js"><link rel="prefetch" href="/assets/types-grammar-1.html.4b5e4a6d.js"><link rel="prefetch" href="/assets/types-grammar-2.html.09993b1d.js"><link rel="prefetch" href="/assets/types-grammar-3.html.d901835c.js"><link rel="prefetch" href="/assets/types-grammar-4.html.e85d4a5d.js"><link rel="prefetch" href="/assets/types-grammar-5.html.a2b81328.js"><link rel="prefetch" href="/assets/types-grammar-apA.html.2924c653.js"><link rel="prefetch" href="/assets/404.html.d2dc3323.js"><link rel="prefetch" href="/assets/1.1.hello-world.html.f87c5e3d.js"><link rel="prefetch" href="/assets/1.10.if.html.77dc3aac.js"><link rel="prefetch" href="/assets/1.11.includes.html.6373ae78.js"><link rel="prefetch" href="/assets/1.12.parameters.html.9058ff22.js"><link rel="prefetch" href="/assets/1.13.push.html.ce608075.js"><link rel="prefetch" href="/assets/1.14.unshift.html.a931245a.js"><link rel="prefetch" href="/assets/1.2.Pick.html.dff96be2.js"><link rel="prefetch" href="/assets/1.3.Awaited.html.81dda58f.js"><link rel="prefetch" href="/assets/1.4.Readonly.html.36238f2d.js"><link rel="prefetch" href="/assets/1.5.Tuple-to-object.html.0b0099ac.js"><link rel="prefetch" href="/assets/1.6.First-of-array.html.00beb244.js"><link rel="prefetch" href="/assets/1.7.Length-of-Tuple.html.f88876ce.js"><link rel="prefetch" href="/assets/1.8.concat.html.8589b1fe.js"><link rel="prefetch" href="/assets/1.9.exclude.html.bc7e747b.js"><link rel="prefetch" href="/assets/2.1.Get-Return-Type.html.cac3876c.js"><link rel="prefetch" href="/assets/2.2.omit.html.f3a4349f.js"><link rel="prefetch" href="/assets/2.3.Readonly2.html.1737beae.js"><link rel="prefetch" href="/assets/2.4.Deep-Readonly.html.0b245458.js"><link rel="prefetch" href="/assets/2.5.turn-to-union.html.0c299433.js"><link rel="prefetch" href="/assets/3.1.Simple-Vue.html.55f2fe53.js"><link rel="prefetch" href="/assets/donate.html.5cb41655.js"><link rel="prefetch" href="/assets/Routine1_pattern-matching-for-extraction.html.6c98f4ad.js"><link rel="prefetch" href="/assets/basic-1.html.6a860dd6.js"><link rel="prefetch" href="/assets/basic-2.html.a6d0227e.js"><link rel="prefetch" href="/assets/basic-3.html.4aa3975b.js"><link rel="prefetch" href="/assets/http-2.html.6c62ded8.js"><link rel="prefetch" href="/assets/http-3.html.ca8b3092.js"><link rel="prefetch" href="/assets/http-interview.html.0e6a6925.js"><link rel="prefetch" href="/assets/http-optimize.html.b4e1bb6a.js"><link rel="prefetch" href="/assets/http-rpc.html.fd6c7486.js"><link rel="prefetch" href="/assets/http-websocket.html.2432d335.js"><link rel="prefetch" href="/assets/https-ecdhe.html.e93a5f88.js"><link rel="prefetch" href="/assets/https-optimize.html.dc41471a.js"><link rel="prefetch" href="/assets/https-rsa.html.daa108b5.js"><link rel="prefetch" href="/assets/ip-base.html.086353f5.js"><link rel="prefetch" href="/assets/ip-ping.html.68033e75.js"><link rel="prefetch" href="/assets/ip-ping_io.html.ebe3c32c.js"><link rel="prefetch" href="/assets/tcp-challenge-ack.html.68ead87a.js"><link rel="prefetch" href="/assets/tcp-dump.html.2de8cf1a.js"><link rel="prefetch" href="/assets/tcp-feature.html.c5a127db.js"><link rel="prefetch" href="/assets/tcp-interview.html.831f8b91.js"><link rel="prefetch" href="/assets/tcp-isn-deff.html.4c6f47e5.js"><link rel="prefetch" href="/assets/tcp-optimize.html.19aa5ce4.js"><link rel="prefetch" href="/assets/tcp-out-of-order-fin.html.facde3d7.js"><link rel="prefetch" href="/assets/tcp-queue.html.451a24bd.js"><link rel="prefetch" href="/assets/tcp-stream.html.222e0df4.js"><link rel="prefetch" href="/assets/tcp-syn.html.e6bc0339.js"><link rel="prefetch" href="/assets/Advanced-1.html.6349fdad.js"><link rel="prefetch" href="/assets/Advanced-2.html.3b4a022c.js"><link rel="prefetch" href="/assets/Advanced-3.html.080f2ab9.js"><link rel="prefetch" href="/assets/Advanced-4.html.9638a4d7.js"><link rel="prefetch" href="/assets/Advanced-5.html.665e8357.js"><link rel="prefetch" href="/assets/base-1.html.7cc0b90c.js"><link rel="prefetch" href="/assets/base-10.html.69d523e6.js"><link rel="prefetch" href="/assets/base-11.html.66768537.js"><link rel="prefetch" href="/assets/base-12.html.57a64e53.js"><link rel="prefetch" href="/assets/base-13.html.bbc769c9.js"><link rel="prefetch" href="/assets/base-14.html.58215026.js"><link rel="prefetch" href="/assets/base-15.html.59b22684.js"><link rel="prefetch" href="/assets/base-16.html.3887a292.js"><link rel="prefetch" href="/assets/base-17.html.b0178761.js"><link rel="prefetch" href="/assets/base-2.html.fb30aa47.js"><link rel="prefetch" href="/assets/base-3.html.b2afde71.js"><link rel="prefetch" href="/assets/base-4.html.ef59e9ed.js"><link rel="prefetch" href="/assets/base-5.html.2ca82580.js"><link rel="prefetch" href="/assets/base-6.html.1b0ab37b.js"><link rel="prefetch" href="/assets/base-7.html.89963722.js"><link rel="prefetch" href="/assets/base-8.html.5bd91515.js"><link rel="prefetch" href="/assets/base-9.html.905d119d.js"><link rel="prefetch" href="/assets/rollup-1.html.6b56ddc8.js"><link rel="prefetch" href="/assets/rollup-10.html.b8bdb04e.js"><link rel="prefetch" href="/assets/rollup-11.html.7bac1960.js"><link rel="prefetch" href="/assets/rollup-2.html.40921e40.js"><link rel="prefetch" href="/assets/rollup-3.html.c53b9c22.js"><link rel="prefetch" href="/assets/rollup-4.html.1a3cf109.js"><link rel="prefetch" href="/assets/rollup-5.html.eea45fb7.js"><link rel="prefetch" href="/assets/rollup-6.html.24eed356.js"><link rel="prefetch" href="/assets/rollup-7.html.7e3895d9.js"><link rel="prefetch" href="/assets/rollup-8.html.a4414797.js"><link rel="prefetch" href="/assets/rollup-9.html.40576d10.js"><link rel="prefetch" href="/assets/scope-closures-appA.html.686c3731.js"><link rel="prefetch" href="/assets/scope-closures-appB.html.ae1a70af.js"><link rel="prefetch" href="/assets/scope-closures-appC.html.beda04da.js"><link rel="prefetch" href="/assets/this-object-prototype-appA.html.1d350ec3.js"><link rel="prefetch" href="/assets/async-performance-apB.html.9c5fb979.js"><link rel="prefetch" href="/assets/async-performance-ch1.html.391cfd51.js"><link rel="prefetch" href="/assets/async-performance-ch2.html.68f1ca43.js"><link rel="prefetch" href="/assets/async-performance-ch3.html.f7b1aea8.js"><link rel="prefetch" href="/assets/async-performance-ch4.html.eab53c5c.js"><link rel="prefetch" href="/assets/async-performance-ch5.html.4625ed62.js"><link rel="prefetch" href="/assets/async-performance-ch6.html.558fb103.js"><link rel="prefetch" href="/assets/types-grammar-1.html.dda1c4aa.js"><link rel="prefetch" href="/assets/types-grammar-2.html.97b42ac4.js"><link rel="prefetch" href="/assets/types-grammar-3.html.53926110.js"><link rel="prefetch" href="/assets/types-grammar-4.html.6c8ab89f.js"><link rel="prefetch" href="/assets/types-grammar-5.html.f0fdc94e.js"><link rel="prefetch" href="/assets/types-grammar-apA.html.a9ef0801.js"><link rel="prefetch" href="/assets/404.html.99e92f7a.js">
    <link rel="stylesheet" href="/assets/style.f4d22aab.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><!--v-if--></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">附录A:*asynquence* 库 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-apA.html#序列-抽象设计" class="router-link-active router-link-exact-active sidebar-item" aria-label="序列，抽象设计"><!--[--><!--]--> 序列，抽象设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-apA.html#asynquence-api" class="router-link-active router-link-exact-active sidebar-item" aria-label="asynquence API"><!--[--><!--]--> asynquence API <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-apA.html#步骤" class="router-link-active router-link-exact-active sidebar-item" aria-label="步骤"><!--[--><!--]--> 步骤 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-apA.html#错误" class="router-link-active router-link-exact-active sidebar-item" aria-label="错误"><!--[--><!--]--> 错误 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-apA.html#并行步骤" class="router-link-active router-link-exact-active sidebar-item" aria-label="并行步骤"><!--[--><!--]--> 并行步骤 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-apA.html#序列分支" class="router-link-active router-link-exact-active sidebar-item" aria-label="序列分支"><!--[--><!--]--> 序列分支 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-apA.html#组合序列" class="router-link-active router-link-exact-active sidebar-item" aria-label="组合序列"><!--[--><!--]--> 组合序列 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-apA.html#值与错误序列" class="router-link-active router-link-exact-active sidebar-item" aria-label="值与错误序列"><!--[--><!--]--> 值与错误序列 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-apA.html#promises-与回调" class="router-link-active router-link-exact-active sidebar-item" aria-label="Promises 与回调"><!--[--><!--]--> Promises 与回调 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-apA.html#可迭代序列" class="router-link-active router-link-exact-active sidebar-item" aria-label="可迭代序列"><!--[--><!--]--> 可迭代序列 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-apA.html#运行-generator" class="router-link-active router-link-exact-active sidebar-item" aria-label="运行 Generator"><!--[--><!--]--> 运行 Generator <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-apA.html#包装过的-generator" class="router-link-active router-link-exact-active sidebar-item" aria-label="包装过的 Generator"><!--[--><!--]--> 包装过的 Generator <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-apA.html#复习" class="router-link-active router-link-exact-active sidebar-item" aria-label="复习"><!--[--><!--]--> 复习 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="附录-a-asynquence-库" tabindex="-1"><a class="header-anchor" href="#附录-a-asynquence-库" aria-hidden="true">#</a> 附录 A: <em>asynquence</em> 库</h1><p>第一章和第二章相当详细地探讨了常见的异步编程模式，以及如何通过回调解决它们。但我们也看到了为什么回调在处理能力上有着致命的缺陷，这将我们带到了第三章和第四章，Promise 与 Generator 为你的异步流程构建提供了一个更加坚实，可信，以及可推理的基础。</p><p>我在这本书中好几次提到我自己的异步库 <em>asynquence</em> (http://github.com/getify/asynquence) —— “async” + “sequence” = “asynquence”，现在我想简要讲解一下它的工作原理，以及它的独特设计为什么很重要和很有用。</p><p>在下一篇附录中，我们将要探索一些高级的异步模式，但为了它们的可用性能够使人接受你可能需要一个库。我们将使用 <em>asynquence</em> 来表达这些模式，所以你会想首先在这里花一点时间来了解这个库。</p><p><em>asynquence</em> 绝对不是优秀异步编码的唯一选择；在这方面当然有许多了不起的库。但是 <em>asynquence</em> 提供了一种独特的视角 —— 通过将这些模式中最好的部分组合进一个单独的库，另外它基于一个基本的抽象：（异步）序列。</p><p>我的前提是，精巧的 JS 程序经常或多或少地需要将各种不同的异步模式交织在一起，而且这通常是完全依靠每个开发者自己去搞清楚的。与其引入关注于异步流程的不同方面的两个或更多的库，<em>asynquence</em> 将它们统一为各种序列步骤，成为单独一个需要学习和部署的核心库。</p><p>我相信 <em>asynquence</em> 有足够高的价值可以使 Promise 风格的异步流程控制编程变得超级容易完成，这就是我们为什么会在这里单单关注这个库。</p><p>开始之前，我将讲解 <em>asynquence</em> 背后的设计原则，然后我们将使用代码示例来展示它的 API 如何工作。</p><h2 id="序列-抽象设计" tabindex="-1"><a class="header-anchor" href="#序列-抽象设计" aria-hidden="true">#</a> 序列，抽象设计</h2><p>对 <em>asynquence</em> 的理解开始于对一个基础抽象的理解：对于一个任务的任何一系列步骤来说，无论它们是同步的还是异步的，都可以被综合地考虑为一个“序列（sequence）”。换句话说，一个序列是一个容器，它代表一个任务，并由一个个完成这个任务的独立的（可能是异步的）步骤组成。</p><p>在这个序列中的每一个步骤都处于一个 Promise（见第三章） 的控制之下。也就是你向一个序列添加的每一个步骤都隐含地创建了一个 Promise，它被链接到这个序列的末尾。由于 Promise 的语义，在一个序列中的每一个步骤的推进都是异步的，即使你同步地完成这个步骤。</p><p>另外，一个序列将总是一步一步线性地进行，也就是步骤 2 总是发生在步骤 1 完成之后，如此类推。</p><p>当然，一个新的序列可以从既存的序列中分支出来，也就是分支仅在主序列在流程中到达那一点时发生。序列还可以用各种方式组合，包括使一个序列在流程中的一个特定的位置汇合另一个序列。</p><p>一个序列与 Promise 链有些相像。但是，在 Promise 链中，不存在一个可以引用整个链条的“把手”可以抓住。不管你持有哪一个 Promise 的引用，它都表示链条中当前的步骤外加挂载在它后面的其他步骤。实质上，你无法持有一个 Promise 链条的引用，除非你持有链条中第一个 Promise 的引用。</p><p>许多情况表明，持有一个综合地指向整个序列的引用是十分有用的。这些情况中最重要的一种就是序列的退出/取消。正如我们在第三章中展开谈过的那样，Promise 本身绝不应当是可以取消的，因为这违反了一个基本设计规则：外部不可变性。</p><p>但是序列没有这样的不可变性设计原则，这主要是由于序列不会作为需要不可变语义的未来值的容器被传递。所以序列是一个处理退出/取消行为的恰当的抽象层面。<em>asynquence</em> 序列可以在任何时候<code>abort()</code>，而且这个序列将会停止在那一点而不会因为任何原因继续下去。</p><p>为了流程控制，还有许多理由首选序列的抽象而非 Promise 链。</p><p>首先，Promise 链是一个更加手动的处理 —— 一旦你开始在你的程序中大面积地创建和链接 Promise ，这种处理可能会变得相当烦冗 —— 在那些使用 Promise 相当恰当的地方，这种烦冗会降低效率而使得开发者不愿使用 Promise。</p><p>抽象意味着减少模板代码和烦冗，所以序列抽象是这个问题的一个好的解决方案。使用 Promise，你关注的是个别的步骤，而且不太会假定你将延续这个链条。而序列采用相反的方式，它假定序列将会无限地持续添加更多步骤。</p><p>当你开始考虑更高阶的 Promise 模式时（除了<code>race([..])</code>和<code>all([..])</code>以外），这种抽象复杂性的降低特别强大。</p><p>例如，在一个序列的中间，你可能想表达一个在概念上类似于<code>try..catch</code>的步骤，它的结果将总是成功，不管是意料之中的主线上的成功解析，还是为被捕获的错误提供一个正面的非错误信号。或者，你可能想表达一个类似于 retry/until 循环的步骤，它不停地尝试相同的步骤直到成功为止。</p><p>仅仅使用基本的 Promise，这类抽象不是很容易表达，而且在一个既存的 Promise 链的中间这样做不好看。但如果你将你的想法抽象为一个序列，并将一个步骤考虑为一个 Promise 的包装，这个包装可以隐藏这样的细节，它就可以使你以最合理的方式考虑流程控制，而不必关心细节。</p><p>第二，也许是更重要的，将异步流程控制考虑为一个序列中的步骤，允许你将这样的细节抽象出去 —— 每一个步骤中引入了哪一种异步性。在这种抽象之下，一个 Promise 将总是控制着步骤，但在抽象之上，这个步骤可以看起来像一个延续回调（简单的默认值），或者一个真正的 Promise，或者一个运行至完成的 Generator，或者... 希望你明白我的意思。</p><p>第三，序列可以通容易地被调整来适应于不同的思考模式，比如基于事件的，基于流的，或者基于相应式的编码。<em>asynquence</em> 提供了一种我称为“响应式序列”的模式（我们稍后讲解），它是 RxJS（“Reactive Extensions”） 中“响应式可监听”思想的变种，允许重复的事件每次触发一个新的序列实例。Promise 是一次性的，所以单独使用 Promise 来表达重复的异步性十分尴尬。</p><p>在一种我称为“可迭代序列”的模式中，另一种思考模式反转了解析/控制能力。与每一个步骤在内部控制它自己的完成（并因此推进这个序列）不同，序列被反转为通过一个外部迭代器来进行推进控制，而且在这个 <em>可迭代序列</em> 中的每一步仅仅应答<code>next(..)</code><em>迭代器</em> 控制。</p><p>在本附录的剩余部分，我们将探索所有这些不同的种类，所以如果我们刚才的步伐太快也不要担心。</p><p>要点是，对于复杂的异步处理来说，序列是一个要比单纯的 Promise（Promise 链）或单纯的 Generator 更加强大与合理的抽象，而 <em>asynquence</em> 被设计为使用恰当层面的语法糖来表达这种抽象，使得异步编程变得更加易于理解和更加令人愉快。</p><h2 id="asynquence-api" tabindex="-1"><a class="header-anchor" href="#asynquence-api" aria-hidden="true">#</a> <em>asynquence</em> API</h2><p>首先，你创建一个序列（一个 <em>asynquence</em> 实例）的方法是使用<code>ASQ(..)</code>函数。一个不带参数的<code>ASQ()</code>调用会创建一个空的初始序列，而向<code>ASQ(..)</code>传递一个或多个值或函数的话，它会使用每个参数值代表序列的初始步骤来创建序列。</p><p><strong>注意：</strong> 为了这里所有的代码示例，我将使用 <em>asynquence</em> 在浏览器全局作用域中的顶层标识符：<code>ASQ</code>。如果你通过一个模块系统（在浏览器或服务器中）引入并使用 <em>asynquence</em>，你当然可以定义自己喜欢的符号，<em>asynquence</em> 不会关心这些！</p><p>许多在这里讨论的 API 方法都内建于 <em>asynquence</em> 的核心部分，而其他的 API 是通过引入可选的“contrib”插件包提供的。要知道一个方法是内建的还是通过插件定义的，可以参见 <em>asynquence</em> 的文档：http://github.com/getify/asynquence</p><h3 id="步骤" tabindex="-1"><a class="header-anchor" href="#步骤" aria-hidden="true">#</a> 步骤</h3><p>如果一个函数代表序列中的一个普通步骤，那么这个函数会被这样调用：第一个参数是延续回调，而任何后续参数都是从前一个步骤中传递下来的消息。在延续回调被调用之前，这个步骤将不会完成。一旦延续回调被调用，你传递给它的任何参数值都会作为序列下一个步骤中的消息被发送。</p><p>要向一个序列添加额外的普通步骤，调用<code>then(..)</code>（它实质上与<code>ASQ(..)</code>调用的语义完全相同）：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">ASQ</span><span class="token punctuation">(</span>
  <span class="token comment">// 步骤 1</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">done</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 步骤 2</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done<span class="token punctuation">,</span> greeting</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">done</span><span class="token punctuation">(</span>greeting <span class="token operator">+</span> <span class="token string">&quot; World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
  <span class="token comment">// 步骤 3</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done<span class="token punctuation">,</span> msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">done</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 步骤 4</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done<span class="token punctuation">,</span> msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// HELLO WORLD</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意：</strong> 虽然<code>then(..)</code>这个名称与原生的 Promise API 完全一样，但是这个<code>then(..)</code>的含义是不同的。你可以传递任意多或者任意少的函数或值给<code>then(..)</code>，而它们中的每一个都被看作是一个分离的步骤。这里与完成/拒绝语义的双回调毫不相干。</p><p>在 Promise 中，可以把一个 Promise 与下一个你在<code>then(..)</code>的完成处理器中创建并<code>return</code>的 Promise 链接。与此不同的是，在 <em>asynquence</em> 中，你所需要做的一切就是调用延续回调 —— 我总是称之为<code>done()</code>，但你可以起任何适合你的名字 —— 并将完成的消息作为参数值选择性地传递给它。</p><p>通过<code>then(..)</code>定义的每一个步骤都被认为是异步的。如果你有一个同步的步骤，你可以立即调用<code>done(..)</code>，或者使用更简单的<code>val(..)</code>步骤帮助函数：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 步骤 1（同步）</span>
<span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 手动同步</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 步骤 2（同步）</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">greeting</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> greeting <span class="token operator">+</span> <span class="token string">&quot; World&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 步骤 3（异步）</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done<span class="token punctuation">,</span> msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">done</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 步骤 4（同步）</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如你所见，<code>val(..)</code>调用的步骤不会收到一个延续回调，因为这部分已经为你做好了 —— 而且参数列表作为一个结果显得不那么凌乱了！要向下一个步骤发送消息，你简单地使用<code>return</code>。</p><p>将<code>val(..)</code>考虑为表示一个同步的“仅含有值”的步骤，它对同步的值操作，比如 logging 之类，非常有用。</p><h3 id="错误" tabindex="-1"><a class="header-anchor" href="#错误" aria-hidden="true">#</a> 错误</h3><p>与 Promise 相比 <em>asynquence</em> 的一个重要的不同之处是错误处理。</p><p>在 Promise 链条中，每个 Promise（步骤）都可以拥有自己独立的错误，而每个后续的步骤都有能力处理或不处理这个错误。这种语义（再一次）主要来自于对每个单独的 Promise 的关注，而非对整个链条（序列）的关注。</p><p>我相信，在大多数情况下，一个位于序列中某一部分的错误通常是不可恢复的，所以序列中后续的步骤毫无意义而应当被跳过。所以，默认情况下，在一个序列的任意一个步骤中的错误会将整个序列置于错误模式，而剩下的普通步骤将会被忽略。</p><p>如果你 <em>确实</em> 需要一个错误可以被恢复的步骤，有几个不同的 API 可以适应这种情况，比如<code>try(..)</code> —— 先前提到过的，有些像<code>try..catch</code>的步骤 —— 或者<code>until(..)</code> —— 一个重试循环，它持续地尝试一个步骤直到它成功或你手动地<code>break()</code>这个循环。<em>asynquence</em> 甚至拥有<code>pThen(..)</code>和<code>pCatch(..)</code>方法，它们的工作方式与普通的 Promise 的<code>then(..)</code>和<code>catch(..)</code>（见第三章）完全相同，所以如果你选择这么做，你就可以进行本地化的序列中错误处理。</p><p>重点是，你同时拥有两个选项，但是在我的经验中更常见的是默认情况。使用 Promise，要使一个步骤的链条在错误发生时一次性忽略所有步骤，你不得不小心不要在任何步骤中注册拒绝处理器；否则，这个错误会被视为处理过而被吞掉，而序列可能仍会继续下去（也许不是意料之中的）。要恰当且可靠地处理这种期待的行为有点儿尴尬。</p><p>要注册一个序列错误通知处理器，<em>asynquence</em> 提供了一个<code>or(..)</code>序列方法，它还有一个别名叫做<code>onerror(..)</code>。你可以在序列的任何位置调用这个方法，而且你可以注册任意多的处理器。这使得让多个不同的消费者监听一个序列是否失败变得很容易；从这个角度讲，它有点儿像一个错误事件处理器。</p><p>正如使用 Promise 那样，所有 JS 异常都会变为序列错误，或者你可以通过编程来发生一个序列错误：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> sq <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 为序列发出一个错误</span>
    done<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;Oops&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 永远不会到达这里</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Oops</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 也不会到达这里</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 稍后</span>

sq<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Oops</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>asynquence</em> 与原生的 Promise 相比，在错误处理上另一个重要的不同就是“未处理异常”的默认行为。正如我们在第三章中以相当的篇幅讨论过的，一个没有被注册拒绝处理器的 Promise 如果被拒绝的话，将会无声地保持（也就是吞掉）那个错误；你不得不总是想着要用一个最后的<code>catch(..)</code>来终结一个链条。</p><p>在 <em>asynquence</em> 中，这种假设被颠倒过来了。</p><p>如果一个错误在序列上发生，而且 <strong>在那个时刻</strong> 它没有被注册错误处理器，那么这个错误会被报告至<code>console</code>。换言之，未处理的的拒绝将总是默认地被报告，因此不会被吞掉或丢掉。</p><p>为了防止重复的噪音，只要你向一个序列注册一个错误处理器，它就会使这个序列从这样的报告中退出。</p><p>事实上有许多情况你想要创建这样一个序列，它可能会在你有机会注册处理器之前就进入错误状态。这不常见，但可能时不时地发生。</p><p>在这样的情况下，你也可以通过在序列上调用<code>defer()</code>来使一个序列实例 <strong>从错误报告中退出</strong>。你应当仅在自己确信不会最终处理这样的错误时，才决定从报告中退出：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> sq1 <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  doesnt<span class="token punctuation">.</span><span class="token function">Exist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将会向控制台抛出异常</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> sq2 <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  doesnt<span class="token punctuation">.</span><span class="token function">Exist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 仅仅会抛出一个序列错误</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 错误报告中的退出</span>
  <span class="token punctuation">.</span><span class="token function">defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  sq1<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  sq2<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ReferenceError （来自sq1）</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这是一种比 Promise 本身拥有的更好的错误处理行为，因为它是一个成功的深渊，而不是一个失败的深渊（参见第三章）。</p><p><strong>注意：</strong> 如果一个序列被导入（也就是被汇合入）另一个序列 —— 完整的描述参见“组合序列” —— 之后源序列从错误报告中退出，那么就必须考虑目标序列是否进行错误报告。</p><h3 id="并行步骤" tabindex="-1"><a class="header-anchor" href="#并行步骤" aria-hidden="true">#</a> 并行步骤</h3><p>在你的序列中不是所有的步骤都将只拥有一个（异步）任务去执行；有些将会需要“并行”（并发地）执行多个步骤。在一个序列中，一个并发地处理多个子步骤的步骤称为一个<code>gate(..)</code> —— 如果你喜欢的话它还有一个别名<code>all(..)</code> —— 而且它与原生的<code>Promise.all([..])</code>是对称的。</p><p>如果在<code>gate(..)</code>中的所有步骤都成功地完成了，那么所有成功的消息都将被传递到下一个序列步骤中。如果它们中的任何一个产生了一个错误，那么整个序列会立即进入错误状态。</p><p>考虑如下代码：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">gate</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">done</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">done</span><span class="token punctuation">(</span><span class="token string">&quot;World&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg1<span class="token punctuation">,</span> msg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ &quot;World&quot;, &quot;!&quot; ]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了展示差异，让我们把这个例子与原生 Promise 比较一下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 注意：这里我们需要一个 [ ]</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;World&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;!&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msgs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ &quot;World&quot;, &quot;!&quot; ]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>讨厌。Promise 需要多得多的模板代码来表达相同的异步流程控制。这个例子很好地说明了为什么 <em>asynquence</em> API 和抽象使得对付 Promise 步骤容易多了。你的异步流程越复杂，它的改进程度就越高。</p><h4 id="各种步骤" tabindex="-1"><a class="header-anchor" href="#各种步骤" aria-hidden="true">#</a> 各种步骤</h4><p>关于 <em>asynquence</em> 的<code>gate(..)</code>步骤类型，有好几种不同的 contrib 插件可能十分有用：</p><ul><li><code>any(..)</code>很像<code>gate(..)</code>，除了为了继续主序列，只需要有一个环节最终必须成功。</li><li><code>first(..)</code>很像<code>any(..)</code>，除了只要有任何一个环节成功，主序列就会继续（忽略任何其余环节产生的后续结果）。</li><li><code>race(..)</code>（与<code>Promise.race([..])</code>对称）很像<code>first(..)</code>，除了主序列会在任何环节完成时（不管成功还是失败）立即继续。</li><li><code>last(..)</code>很像<code>any(..)</code>，除了只有最后一个环节成功完成时才会把它的消息发送给主序列。</li><li><code>none(..)</code>是<code>gate(..)</code>的反义：主序列仅在所有环节失败时才会继续（将所有环节的错误消息作为成功消息传送，或者反之）。</li></ul><p>让我们首先定义一些帮助函数来使示例清晰一些：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">success1</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">success2</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">failure3</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    done<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">output</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在，让我们展示一些这些<code>gate(..)</code>步骤的变种：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span>
	failure3<span class="token punctuation">,</span>
	success1
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span> output <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 3</span>


<span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span>
	success1<span class="token punctuation">,</span>
	failure3<span class="token punctuation">,</span>
	success2
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> arguments <span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
		args		<span class="token comment">// [ 1, undefined, 2 ]</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span>
	failure3<span class="token punctuation">,</span>
	success1<span class="token punctuation">,</span>
	success2
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> output <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 1</span>


<span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span>
	failure3<span class="token punctuation">,</span>
	success1<span class="token punctuation">,</span>
	success2
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> output <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 2</span>

<span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">none</span><span class="token punctuation">(</span>
	failure3
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> output <span class="token punctuation">)</span>		<span class="token comment">// 3</span>
<span class="token punctuation">.</span><span class="token function">none</span><span class="token punctuation">(</span>
	failure3
	success1
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span> output <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>另一个步骤种类是<code>map(..)</code>，它让你将一个数组的元素异步地映射为不同的值，而且在所有映射完成之前步骤不会前进。<code>map(..)</code>与<code>gate(..)</code>十分相似，除了它从一个数组，而非从一个指定的分离函数那里得到初始值，而且你定义一个函数回调来操作每一个值：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">double</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">done</span><span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> double<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [2,4,6]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>另外，<code>map(..)</code>可以从前一步骤传递来的消息中收到它的两个参数（数组或者回调）：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">done</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>double<span class="token punctuation">)</span> <span class="token comment">// 收到消息`[1,2,3]`</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>plusOne<span class="token punctuation">)</span> <span class="token comment">// 收到消息`[2,4,6]`</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [3,5,7]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>另一个种类是<code>waterfall(..)</code>，它有些像混合了<code>gate(..)</code>的消息收集行为与<code>then(..)</code>的序列化处理。</p><p>步骤 1 首先被执行，然后来自步骤 1 的成功消息被传递给步骤 2，然后两个成功消息走到步骤 3，然后所有三个成功消息走到步骤 4，如此继续，这样消息被某种程度上收集并从“瀑布”上倾泻而下。</p><p>考虑如下代码：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">double</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">done</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span>args<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">waterfall</span><span class="token punctuation">(</span>
    double<span class="token punctuation">,</span> <span class="token comment">// [ 3 ]</span>
    double<span class="token punctuation">,</span> <span class="token comment">// [ 6 ]</span>
    double<span class="token punctuation">,</span> <span class="token comment">// [ 6, 12 ]</span>
    double <span class="token comment">// [ 6, 12, 24 ]</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 6, 12, 24, 48 ]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果在“瀑布”的任何一点发生错误，那么整个序列就会立即进入错误状态。</p><h4 id="容错" tabindex="-1"><a class="header-anchor" href="#容错" aria-hidden="true">#</a> 容错</h4><p>有时你想在步骤一级管理错误，而不一定让它们使整个序列成为错误状态。<em>asynquence</em> 为此提供了两种步骤类型。</p><p><code>try(..)</code>尝试一个步骤，如果它成功，序列就会正常继续，但如果这个步骤失败了，失败的状态会转换成格式为<code>{ catch: .. }</code>的成功消息，它的值由错误消息填充：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">try</span><span class="token punctuation">(</span>success1<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span> <span class="token comment">// 1</span>
  <span class="token punctuation">.</span><span class="token function">try</span><span class="token punctuation">(</span>failure3<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span> <span class="token comment">// { catch: 3 }</span>
  <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 永远不会到达这里</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你还可以使用<code>until(..)</code>构建一个重试循环，它尝试一个步骤，如果失败，就会在下一个事件轮询的 tick 中重试这个步骤，如此继续。</p><p>这种重试循环可以无限延续下去，但如果你想要从循环中跳出来，你可以在完成触发器上调用<code>break()</code>标志方法，它将主序列置为错误状态：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">until</span><span class="token punctuation">(</span>double<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span> <span class="token comment">// 6</span>
  <span class="token punctuation">.</span><span class="token function">until</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    count<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        done<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 跳出 `until(..)` 重试循环</span>
        done<span class="token punctuation">.</span><span class="token function">break</span><span class="token punctuation">(</span><span class="token string">&quot;Oops&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Oops</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="promise-式的步骤" tabindex="-1"><a class="header-anchor" href="#promise-式的步骤" aria-hidden="true">#</a> Promise 式的步骤</h4><p>如果你喜欢在你的序列中内联 Promise 风格的语义，比如 Promise 的<code>then(..)</code>和<code>catch(..)</code>（见第三章），你可以使用<code>pThen</code>和<code>pCatch</code>插件：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pThen</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> msg <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pThen</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span> <span class="token comment">// 42</span>
  <span class="token punctuation">.</span><span class="token function">pThen</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 抛出一个异常</span>
    doesnt<span class="token punctuation">.</span><span class="token function">Exist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pCatch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 捕获这个异常（拒绝）</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 主旋律回归到正常状态，</span>
    <span class="token comment">// 因为前一个异常已经被</span>
    <span class="token comment">// `pCatch(..)`捕获了</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>pThen(..)</code>和<code>pCatch(..)</code>被设计为运行在序列中，但好像在普通的 Promise 链中动作。这样，你就可以在传递给<code>pThen(..)</code>的“完成”处理器中解析纯粹的 Promise 或者 <em>asynquence</em> 序列。</p><h3 id="序列分支" tabindex="-1"><a class="header-anchor" href="#序列分支" aria-hidden="true">#</a> 序列分支</h3><p>一个有关 Promise 的可能十分有用的特性是，你可以在同一个 Promise 上添附多个<code>then(..)</code>处理器，这实质上在这个 Promise 的流程上创建了“分支”：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// （从`p`开始的）分支 1</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> msg <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// （从`p`开始的）分支 2</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 21</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用 <em>asynquence</em> 的<code>fork()</code>可以很容易地进行同样的“分支”：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> sq <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> sq2 <span class="token operator">=</span> sq<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 分支 1</span>
sq<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>

<span class="token comment">// 分支 2</span>
sq2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="组合序列" tabindex="-1"><a class="header-anchor" href="#组合序列" aria-hidden="true">#</a> 组合序列</h3><p>与<code>fork()</code>相反的是，你可以通过将一个序列汇合进另一个来组合两个序列，使用<code>seq(..)</code>实例方法：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> sq <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 将序列 `sq` 汇合进这个系列</span>
  <span class="token punctuation">.</span><span class="token function">seq</span><span class="token punctuation">(</span>sq<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello World</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>seq(..)</code>可以像这里展示的那样接收一个序列本身，或者接收一个函数。如果是一个函数，那么它会期待这个函数被调用时返回一个序列，所以前面的代码可以这样写：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// ..</span>
<span class="token punctuation">.</span><span class="token function">seq</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> sq<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token comment">// ..</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>另外，这个步骤还可以使用<code>pipe(..)</code>来完成：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// ..</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// 将 `sq` 导入延续回调 `done`</span>
	sq<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span> done <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token comment">// ..</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当一个序列被汇合时，它的成功消息流和错误消息流都会被导入。</p><p><strong>注意：</strong> 正如早先的注意事项中提到过的，导入会使源序列从错误报告中退出，但不会影响目标序列的错误报告状态。</p><h2 id="值与错误序列" tabindex="-1"><a class="header-anchor" href="#值与错误序列" aria-hidden="true">#</a> 值与错误序列</h2><p>如果一个序列的任意一个步骤只是一个普通值，那么这个值就会被映射到这个步骤的完成消息中：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> sq <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sq<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果你想制造一个自动出错的序列：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> sq <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token string">&quot;Oops&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">seq</span><span class="token punctuation">(</span>sq<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不会到达这里</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Oops</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你还可能想要自动地创建一个延迟的值或者延迟的错误序列。使用<code>after</code>和<code>failAfter</code> contrib 插件，这很容易：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> sq1 <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sq2 <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">failAfter</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">&quot;Oops&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sq1<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg1<span class="token punctuation">,</span> msg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg1<span class="token punctuation">,</span> msg2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello World</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sq2<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Oops</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你还可以使用<code>after&#39;(..)</code>在一个序列的中间插入一个延迟：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
  <span class="token comment">// 在这个序列中插入一个延迟</span>
  <span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="promises-与回调" tabindex="-1"><a class="header-anchor" href="#promises-与回调" aria-hidden="true">#</a> Promises 与回调</h2><p>我认为 <em>asynquence</em> 序列在原生的 Promise 之上提供了许多价值，而且你会发现在很大程度上它在抽象层面上使用起来更舒适更强大。然而，将 <em>asynquence</em> 与其他非 <em>asynquence</em> 代码进行整合将是不可避免的现实。</p><p>使用<code>promise(..)</code>实例方法，你可以很容易地将一个 Promise（也就是 thenable —— 见第三章）汇合进一个序列：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token comment">// 本可以写做：`function(){ return p; }`</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>要向相反的方向走，从一个序列的特定步骤中分支/出让一个 Promise，使用<code>toPromise</code> contrib 插件：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> sq <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sq<span class="token punctuation">.</span><span class="token function">toPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 现在这是一个标准的 promise 链了</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> msg<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// HELLO WORLD</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有好几种帮助设施可以在使用回调的系统中适配 <em>asynquence</em>。要从你的序列中自动地生成一个“错误优先风格”回调，来接入一个面向回调的工具，使用<code>errfcb</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> sq <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 注意：这里期待“错误优先风格”的回调</span>
  <span class="token function">someAsyncFuncWithCB</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> done<span class="token punctuation">.</span>errfcb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ..</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ..</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注意：这里期待“错误优先风格”的回调</span>
<span class="token function">anotherAsyncFuncWithCB</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> sq<span class="token punctuation">.</span><span class="token function">errfcb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你还可能想要创建一个工具的序列包装版本 —— 与第三章的“promisory”和第四章的“thunkory”相比较 —— <em>asynquence</em> 为此提供了<code>ASQ.wrap(..)</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> coolUtility <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>someAsyncFuncWithCB<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">coolUtility</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ..</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ..</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意：</strong> 为了清晰（和有趣！），让我们为来自<code>ASQ.wrap(..)</code>的产生序列的函数杜撰另一个名词，就像这里的<code>coolUtility</code>。我提议“sequory”（“sequence” + “factory”）。</p><h2 id="可迭代序列" tabindex="-1"><a class="header-anchor" href="#可迭代序列" aria-hidden="true">#</a> 可迭代序列</h2><p>一个序列普通的范例是，每一个步骤都负责完成它自己，进而推进这个序列。Promise 就是这样工作的。</p><p>不幸的是，有时你需要从外部控制一个 Promise/步骤，而这会导致尴尬的“能力抽取”。</p><p>考虑这个 Promise 的例子：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> domready <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 不想把这个放在这里，因为在逻辑上</span>
  <span class="token comment">// 它属于代码的另一部分</span>
  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ..</span>

domready<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// DOM 准备好了！</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关于 Promise 的“能力抽取”范模式看起来像这样：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> ready<span class="token punctuation">;</span>

<span class="token keyword">var</span> domready <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 抽取 `resolve()` 能力</span>
  ready <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ..</span>

domready<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// DOM 准备好了！</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ..</span>

document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> ready<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意：</strong> 在我看来，这种反模式是一种尴尬的代码风格，但有些开发者喜欢，我不能理解其中的原因。</p><p><em>asynquence</em> 提供一种我称为“可迭代序列”的反转序列类型，它将控制能力外部化（它在<code>domready</code>这样的情况下十分有用）：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 注意：这里`domready`是一个控制序列的 *迭代器*</span>
<span class="token keyword">var</span> domready <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">iterable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ..</span>

domready<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// DOM 准备好了！</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ..</span>

document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> domready<span class="token punctuation">.</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>与我们在这个场景中看到的东西比起来，可迭代序列还有很多内容。我们将在附录 B 中回过头来讨论它们。</p><h2 id="运行-generator" tabindex="-1"><a class="header-anchor" href="#运行-generator" aria-hidden="true">#</a> 运行 Generator</h2><p>在第四章中，我们衍生了一种称为<code>run(..)</code>的工具，它可以将 generator 运行至完成，监听被<code>yield</code>的 Promise 并使用它们来异步推进 generator。<em>asynquence</em> 正好有一个这样的内建工具，称为<code>runner(..)</code>。</p><p>为了展示，让我们首先建立一些帮助函数：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">doublePr</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">doubleSeq</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">done</span><span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在，我们可以在一个序列的中间使用<code>runner(..)</code>作为一个步骤：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">runner</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> x <span class="token operator">=</span> token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// yield 一个真正的 promise</span>
    x <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">doublePr</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// yield 一个序列</span>
    x <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">doubleSeq</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> x<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 84</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="包装过的-generator" tabindex="-1"><a class="header-anchor" href="#包装过的-generator" aria-hidden="true">#</a> 包装过的 Generator</h3><p>你还可以创建自包装的 generator —— 也就是一个普通函数，运行你指定的 generator 并为它的完成返回一个序列 —— 通过<code>ASQ.wrap(..)</code>包装它：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> x <span class="token operator">=</span> token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// yield 一个真正的 promise</span>
    x <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">doublePr</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// yield 一个序列</span>
    x <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">doubleSeq</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> x<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">gen</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ..</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 68</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>runner(..)</code>还能做很多很牛的事情，我们会在附录 B 中回过头来讨论它。</p><h2 id="复习" tabindex="-1"><a class="header-anchor" href="#复习" aria-hidden="true">#</a> 复习</h2><p><em>asynquence</em> 是一个在 Promise 之上的简单抽象 —— 一个序列是一系列（异步）步骤，它的目标是使各种异步模式更加容易使用，而在功能上没有任何妥协。</p><p>在 <em>asynquence</em> 的核心 API 与它的 contrib 插件中，除了我们在这篇附录中看到的内容以外还有其他的好东西，我们把对这些剩余功能的探索作为练习留给读者。</p><p>现在你看到了 <em>asynquence</em> 的实质与精神。关键点是，一个序列由许多步骤组成，而这些步骤可以使许多不同种类的 Promise，或者它们可以是一个 generator 运行器，或者... 选择由你来决定，你有完全的自由为你的任务采用恰当的任何异步流程控制逻辑。</p><p>如果你能理解这些 <em>asynquence</em> 代码段，那么你现在就可以相当快地学会这个库；它实际上没有那么难学！</p><p>如果你依然对它如何（或为什么！）工作感到模糊，那么在进入下一篇附录之前，你将会想要多花一点时间去查看前面的例子，并亲自把玩一下 <em>asynquence</em>。附录 B 将会在几种更高级更强大的异步模式中使用 <em>asynquence</em>。</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 1453300745@qq.com">W-HanYu</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.c62ce33e.js" defer></script>
  </body>
</html>
