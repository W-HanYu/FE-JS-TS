<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>第5章:程序性能 | </title><meta name="description" content="">
    <link rel="modulepreload" href="/assets/app.10857eea.js"><link rel="modulepreload" href="/assets/async-performance-ch5.html.40c03aff.js"><link rel="modulepreload" href="/assets/async-performance-ch5.html.25a5f200.js"><link rel="prefetch" href="/assets/1.1.hello-world.html.64e999cb.js"><link rel="prefetch" href="/assets/1.10.if.html.943cdf0c.js"><link rel="prefetch" href="/assets/1.11.includes.html.571e5f8c.js"><link rel="prefetch" href="/assets/1.12.parameters.html.564dfc8c.js"><link rel="prefetch" href="/assets/1.13.push.html.b72bad70.js"><link rel="prefetch" href="/assets/1.14.unshift.html.3d0b1ac3.js"><link rel="prefetch" href="/assets/1.2.Pick.html.1cf0b401.js"><link rel="prefetch" href="/assets/1.3.Awaited.html.85e83850.js"><link rel="prefetch" href="/assets/1.4.Readonly.html.512547f5.js"><link rel="prefetch" href="/assets/1.5.Tuple-to-object.html.f9930299.js"><link rel="prefetch" href="/assets/1.6.First-of-array.html.b0696427.js"><link rel="prefetch" href="/assets/1.7.Length-of-Tuple.html.06336084.js"><link rel="prefetch" href="/assets/1.8.concat.html.c900e85e.js"><link rel="prefetch" href="/assets/1.9.exclude.html.3d9c9834.js"><link rel="prefetch" href="/assets/2.1.Get-Return-Type.html.1b889bcc.js"><link rel="prefetch" href="/assets/2.2.omit.html.20d83bcf.js"><link rel="prefetch" href="/assets/2.3.Readonly2.html.031c531b.js"><link rel="prefetch" href="/assets/2.4.Deep-Readonly.html.7fde66b5.js"><link rel="prefetch" href="/assets/2.5.turn-to-union.html.af1c2948.js"><link rel="prefetch" href="/assets/3.1.Simple-Vue.html.3007ed82.js"><link rel="prefetch" href="/assets/basic-1.html.57108e15.js"><link rel="prefetch" href="/assets/basic-2.html.b238470b.js"><link rel="prefetch" href="/assets/basic-3.html.1a2b8e1b.js"><link rel="prefetch" href="/assets/http-2.html.35c8ed2a.js"><link rel="prefetch" href="/assets/http-3.html.1e314715.js"><link rel="prefetch" href="/assets/http-interview.html.4bb6817e.js"><link rel="prefetch" href="/assets/http-optimize.html.6d2d3508.js"><link rel="prefetch" href="/assets/http-rpc.html.5f76b948.js"><link rel="prefetch" href="/assets/http-websocket.html.59ef70c5.js"><link rel="prefetch" href="/assets/https-ecdhe.html.8c1f5f63.js"><link rel="prefetch" href="/assets/https-optimize.html.5758cdcd.js"><link rel="prefetch" href="/assets/https-rsa.html.2191d477.js"><link rel="prefetch" href="/assets/ip-base.html.7af4058e.js"><link rel="prefetch" href="/assets/ip-ping.html.3431e393.js"><link rel="prefetch" href="/assets/ip-ping_io.html.1d01cf43.js"><link rel="prefetch" href="/assets/tcp-challenge-ack.html.4dc1810d.js"><link rel="prefetch" href="/assets/tcp-dump.html.e58a0c7c.js"><link rel="prefetch" href="/assets/tcp-feature.html.2396dace.js"><link rel="prefetch" href="/assets/tcp-interview.html.30af561a.js"><link rel="prefetch" href="/assets/tcp-isn-deff.html.743a32bd.js"><link rel="prefetch" href="/assets/tcp-optimize.html.4370769b.js"><link rel="prefetch" href="/assets/tcp-out-of-order-fin.html.5044867e.js"><link rel="prefetch" href="/assets/tcp-queue.html.77e274c7.js"><link rel="prefetch" href="/assets/tcp-stream.html.83c63ce4.js"><link rel="prefetch" href="/assets/tcp-syn.html.96c19b66.js"><link rel="prefetch" href="/assets/donate.html.d9928a63.js"><link rel="prefetch" href="/assets/Routine1_pattern-matching-for-extraction.html.304b153a.js"><link rel="prefetch" href="/assets/Advanced-1.html.353f6c87.js"><link rel="prefetch" href="/assets/Advanced-2.html.88bb5264.js"><link rel="prefetch" href="/assets/Advanced-3.html.96bb2cc6.js"><link rel="prefetch" href="/assets/Advanced-4.html.3ca80786.js"><link rel="prefetch" href="/assets/Advanced-5.html.c867a8f0.js"><link rel="prefetch" href="/assets/Extended-article-1.html.6c21c6c7.js"><link rel="prefetch" href="/assets/base-1.html.502a2ddb.js"><link rel="prefetch" href="/assets/base-10.html.6a577a2f.js"><link rel="prefetch" href="/assets/base-11.html.ba242773.js"><link rel="prefetch" href="/assets/base-12.html.bf38defb.js"><link rel="prefetch" href="/assets/base-13.html.e2815939.js"><link rel="prefetch" href="/assets/base-14.html.91f5ff1a.js"><link rel="prefetch" href="/assets/base-15.html.17167a0d.js"><link rel="prefetch" href="/assets/base-16.html.8107a224.js"><link rel="prefetch" href="/assets/base-17.html.88056264.js"><link rel="prefetch" href="/assets/base-2.html.2bd656bb.js"><link rel="prefetch" href="/assets/base-3.html.57130013.js"><link rel="prefetch" href="/assets/base-4.html.52612b71.js"><link rel="prefetch" href="/assets/base-5.html.8f5804c6.js"><link rel="prefetch" href="/assets/base-6.html.676fd870.js"><link rel="prefetch" href="/assets/base-7.html.c35649b2.js"><link rel="prefetch" href="/assets/base-8.html.f62a44d6.js"><link rel="prefetch" href="/assets/base-9.html.e15334be.js"><link rel="prefetch" href="/assets/rollup-1.html.a0e88271.js"><link rel="prefetch" href="/assets/rollup-10.html.d7457140.js"><link rel="prefetch" href="/assets/rollup-11.html.387a1d50.js"><link rel="prefetch" href="/assets/rollup-2.html.272f10b1.js"><link rel="prefetch" href="/assets/rollup-3.html.3bfd8692.js"><link rel="prefetch" href="/assets/rollup-4.html.56636c64.js"><link rel="prefetch" href="/assets/rollup-5.html.11f34699.js"><link rel="prefetch" href="/assets/rollup-6.html.626d4ddb.js"><link rel="prefetch" href="/assets/rollup-7.html.560b9cf5.js"><link rel="prefetch" href="/assets/rollup-8.html.97dd433f.js"><link rel="prefetch" href="/assets/rollup-9.html.1d3a455c.js"><link rel="prefetch" href="/assets/scope-closures-appA.html.fe38f021.js"><link rel="prefetch" href="/assets/scope-closures-appB.html.8b005e05.js"><link rel="prefetch" href="/assets/scope-closures-appC.html.081c0336.js"><link rel="prefetch" href="/assets/this-object-prototype-appA.html.7018895f.js"><link rel="prefetch" href="/assets/async-performance-apA.html.3ca37a19.js"><link rel="prefetch" href="/assets/async-performance-apB.html.a8593452.js"><link rel="prefetch" href="/assets/async-performance-ch1.html.f52ab151.js"><link rel="prefetch" href="/assets/async-performance-ch2.html.75e5e133.js"><link rel="prefetch" href="/assets/async-performance-ch3.html.9dc2d68e.js"><link rel="prefetch" href="/assets/async-performance-ch4.html.240640d5.js"><link rel="prefetch" href="/assets/async-performance-ch6.html.d865cab7.js"><link rel="prefetch" href="/assets/types-grammar-1.html.3a0001f4.js"><link rel="prefetch" href="/assets/types-grammar-2.html.ae03c918.js"><link rel="prefetch" href="/assets/types-grammar-3.html.1aefd5a9.js"><link rel="prefetch" href="/assets/types-grammar-4.html.8ce8557b.js"><link rel="prefetch" href="/assets/types-grammar-5.html.dc3bb8a0.js"><link rel="prefetch" href="/assets/types-grammar-apA.html.b06bd67a.js"><link rel="prefetch" href="/assets/404.html.d2dc3323.js"><link rel="prefetch" href="/assets/1.1.hello-world.html.42e63562.js"><link rel="prefetch" href="/assets/1.10.if.html.29947578.js"><link rel="prefetch" href="/assets/1.11.includes.html.6439af8c.js"><link rel="prefetch" href="/assets/1.12.parameters.html.f743e93e.js"><link rel="prefetch" href="/assets/1.13.push.html.d381f6e4.js"><link rel="prefetch" href="/assets/1.14.unshift.html.f7697a1b.js"><link rel="prefetch" href="/assets/1.2.Pick.html.5c8b261a.js"><link rel="prefetch" href="/assets/1.3.Awaited.html.00167622.js"><link rel="prefetch" href="/assets/1.4.Readonly.html.4fb48369.js"><link rel="prefetch" href="/assets/1.5.Tuple-to-object.html.0580b17a.js"><link rel="prefetch" href="/assets/1.6.First-of-array.html.2a8e2362.js"><link rel="prefetch" href="/assets/1.7.Length-of-Tuple.html.22ef7a18.js"><link rel="prefetch" href="/assets/1.8.concat.html.00c48e5c.js"><link rel="prefetch" href="/assets/1.9.exclude.html.9ad334e4.js"><link rel="prefetch" href="/assets/2.1.Get-Return-Type.html.31b52d2c.js"><link rel="prefetch" href="/assets/2.2.omit.html.fa3119b1.js"><link rel="prefetch" href="/assets/2.3.Readonly2.html.64f6aa55.js"><link rel="prefetch" href="/assets/2.4.Deep-Readonly.html.4e77227e.js"><link rel="prefetch" href="/assets/2.5.turn-to-union.html.e2d039fc.js"><link rel="prefetch" href="/assets/3.1.Simple-Vue.html.2b7f1073.js"><link rel="prefetch" href="/assets/basic-1.html.9c7edcc0.js"><link rel="prefetch" href="/assets/basic-2.html.8f694f24.js"><link rel="prefetch" href="/assets/basic-3.html.21ccd2e6.js"><link rel="prefetch" href="/assets/http-2.html.c1fb6ec6.js"><link rel="prefetch" href="/assets/http-3.html.c5a63bbe.js"><link rel="prefetch" href="/assets/http-interview.html.9564e879.js"><link rel="prefetch" href="/assets/http-optimize.html.9aeae060.js"><link rel="prefetch" href="/assets/http-rpc.html.e910cca5.js"><link rel="prefetch" href="/assets/http-websocket.html.eabf2195.js"><link rel="prefetch" href="/assets/https-ecdhe.html.4bd399d3.js"><link rel="prefetch" href="/assets/https-optimize.html.9fa887e8.js"><link rel="prefetch" href="/assets/https-rsa.html.b6695c4c.js"><link rel="prefetch" href="/assets/ip-base.html.88864407.js"><link rel="prefetch" href="/assets/ip-ping.html.b4d2cf0d.js"><link rel="prefetch" href="/assets/ip-ping_io.html.d9be93c0.js"><link rel="prefetch" href="/assets/tcp-challenge-ack.html.aec13b10.js"><link rel="prefetch" href="/assets/tcp-dump.html.5054c0a0.js"><link rel="prefetch" href="/assets/tcp-feature.html.e5f8705a.js"><link rel="prefetch" href="/assets/tcp-interview.html.5d5ed84e.js"><link rel="prefetch" href="/assets/tcp-isn-deff.html.50713709.js"><link rel="prefetch" href="/assets/tcp-optimize.html.bdddfd5b.js"><link rel="prefetch" href="/assets/tcp-out-of-order-fin.html.44ca7d32.js"><link rel="prefetch" href="/assets/tcp-queue.html.f96f1ac8.js"><link rel="prefetch" href="/assets/tcp-stream.html.f50b922c.js"><link rel="prefetch" href="/assets/tcp-syn.html.d4e27147.js"><link rel="prefetch" href="/assets/donate.html.5f5ee7cc.js"><link rel="prefetch" href="/assets/Routine1_pattern-matching-for-extraction.html.88e65250.js"><link rel="prefetch" href="/assets/Advanced-1.html.bd965a69.js"><link rel="prefetch" href="/assets/Advanced-2.html.ed37106b.js"><link rel="prefetch" href="/assets/Advanced-3.html.f637c11b.js"><link rel="prefetch" href="/assets/Advanced-4.html.13461ce2.js"><link rel="prefetch" href="/assets/Advanced-5.html.302a61c3.js"><link rel="prefetch" href="/assets/Extended-article-1.html.5b418970.js"><link rel="prefetch" href="/assets/base-1.html.b28e0e4f.js"><link rel="prefetch" href="/assets/base-10.html.db4a2b18.js"><link rel="prefetch" href="/assets/base-11.html.2dbfcb2c.js"><link rel="prefetch" href="/assets/base-12.html.9d00161a.js"><link rel="prefetch" href="/assets/base-13.html.e68063f5.js"><link rel="prefetch" href="/assets/base-14.html.448b967d.js"><link rel="prefetch" href="/assets/base-15.html.1877967e.js"><link rel="prefetch" href="/assets/base-16.html.1196549a.js"><link rel="prefetch" href="/assets/base-17.html.786ede5c.js"><link rel="prefetch" href="/assets/base-2.html.1a77f5e3.js"><link rel="prefetch" href="/assets/base-3.html.8d411cba.js"><link rel="prefetch" href="/assets/base-4.html.3cf75c04.js"><link rel="prefetch" href="/assets/base-5.html.75cba69b.js"><link rel="prefetch" href="/assets/base-6.html.e2f1d2a2.js"><link rel="prefetch" href="/assets/base-7.html.1a7bea3f.js"><link rel="prefetch" href="/assets/base-8.html.f98cc478.js"><link rel="prefetch" href="/assets/base-9.html.5f235b4f.js"><link rel="prefetch" href="/assets/rollup-1.html.068a143d.js"><link rel="prefetch" href="/assets/rollup-10.html.ac1b5d1d.js"><link rel="prefetch" href="/assets/rollup-11.html.0eb72a05.js"><link rel="prefetch" href="/assets/rollup-2.html.7f877d86.js"><link rel="prefetch" href="/assets/rollup-3.html.9db7ab19.js"><link rel="prefetch" href="/assets/rollup-4.html.03417866.js"><link rel="prefetch" href="/assets/rollup-5.html.6bf2ac07.js"><link rel="prefetch" href="/assets/rollup-6.html.f60dcba5.js"><link rel="prefetch" href="/assets/rollup-7.html.43d61667.js"><link rel="prefetch" href="/assets/rollup-8.html.800da36b.js"><link rel="prefetch" href="/assets/rollup-9.html.611f6880.js"><link rel="prefetch" href="/assets/scope-closures-appA.html.74216843.js"><link rel="prefetch" href="/assets/scope-closures-appB.html.70010aba.js"><link rel="prefetch" href="/assets/scope-closures-appC.html.63cec5a0.js"><link rel="prefetch" href="/assets/this-object-prototype-appA.html.8185c311.js"><link rel="prefetch" href="/assets/async-performance-apA.html.3a4bf124.js"><link rel="prefetch" href="/assets/async-performance-apB.html.87add98c.js"><link rel="prefetch" href="/assets/async-performance-ch1.html.0ab91e47.js"><link rel="prefetch" href="/assets/async-performance-ch2.html.21b1e563.js"><link rel="prefetch" href="/assets/async-performance-ch3.html.a1d122a3.js"><link rel="prefetch" href="/assets/async-performance-ch4.html.0be79629.js"><link rel="prefetch" href="/assets/async-performance-ch6.html.267fc5f0.js"><link rel="prefetch" href="/assets/types-grammar-1.html.21f879fa.js"><link rel="prefetch" href="/assets/types-grammar-2.html.191d3b5d.js"><link rel="prefetch" href="/assets/types-grammar-3.html.6156f983.js"><link rel="prefetch" href="/assets/types-grammar-4.html.78ab5f14.js"><link rel="prefetch" href="/assets/types-grammar-5.html.6c58e8d6.js"><link rel="prefetch" href="/assets/types-grammar-apA.html.90bd1ed7.js"><link rel="prefetch" href="/assets/404.html.8eda9d50.js">
    <link rel="stylesheet" href="/assets/style.f4d22aab.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><!--v-if--></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">第5章:程序性能 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-ch5.html#web-workers" class="router-link-active router-link-exact-active sidebar-item" aria-label="Web Workers"><!--[--><!--]--> Web Workers <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-ch5.html#worker-环境" class="router-link-active router-link-exact-active sidebar-item" aria-label="Worker 环境"><!--[--><!--]--> Worker 环境 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-ch5.html#数据传送" class="router-link-active router-link-exact-active sidebar-item" aria-label="数据传送"><!--[--><!--]--> 数据传送 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-ch5.html#共享的-workers" class="router-link-active router-link-exact-active sidebar-item" aria-label="共享的 Workers"><!--[--><!--]--> 共享的 Workers <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-ch5.html#填补-web-workers" class="router-link-active router-link-exact-active sidebar-item" aria-label="填补 Web Workers"><!--[--><!--]--> 填补 Web Workers <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-ch5.html#simd" class="router-link-active router-link-exact-active sidebar-item" aria-label="SIMD"><!--[--><!--]--> SIMD <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-ch5.html#asm-js" class="router-link-active router-link-exact-active sidebar-item" aria-label="asm.js"><!--[--><!--]--> asm.js <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-ch5.html#如何使用-asm-js-进行优化" class="router-link-active router-link-exact-active sidebar-item" aria-label="如何使用 asm.js 进行优化"><!--[--><!--]--> 如何使用 asm.js 进行优化 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-ch5.html#asm-js-模块" class="router-link-active router-link-exact-active sidebar-item" aria-label="asm.js 模块"><!--[--><!--]--> asm.js 模块 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/you-dont-know-js/volume-2/async-performance-ch5.html#复习" class="router-link-active router-link-exact-active sidebar-item" aria-label="复习"><!--[--><!--]--> 复习 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="第5章-程序性能" tabindex="-1"><a class="header-anchor" href="#第5章-程序性能" aria-hidden="true">#</a> 第5章: 程序性能</h1><p>这本书至此一直是关于如何更有效地利用异步模式。但是我们还没有直接解释为什么异步对于 JS 如此重要。最明显明确的理由就是 <strong>性能</strong>。</p><p>举个例子，如果你要发起两个 Ajax 请求，而且他们是相互独立的，但你在进行下一个任务之前需要等到他们全部完成，你就有两种选择来对这种互动建立模型：顺序和并发。</p><p>你可以发起第一个请求并等到它完成再发起第二个请求。或者，就像我们在 promise 和 generator 中看到的那样，你可以“并列地”发起两个请求，并在继续下一步之前让一个“门”等待它们全部完成。</p><p>显然，后者要比前者性能更好。而更好的性能一般都会带来更好的用户体验。</p><p>异步（并发穿插）甚至可能仅仅增强高性能的印象，即便整个程序依然要用相同的时间才成完成。用户对性能的印象意味着一切——如果不能再多的话！——和实际可测量的性能一样重要。</p><p>现在，我们想超越局部的异步模式，转而在程序级别的水平上讨论一些宏观的性能细节。</p><p><strong>注意：</strong> 你可能会想知道关于微性能问题，比如<code>a++</code>与<code>++a</code>哪个更快。我们会在下一章“基准分析与调优”中讨论这类性能细节。</p><h2 id="web-workers" tabindex="-1"><a class="header-anchor" href="#web-workers" aria-hidden="true">#</a> Web Workers</h2><p>如果你有一些处理密集型的任务，但你不想让它们在主线程上运行（那样会使浏览器/UI 变慢），你可能会希望 JavaScript 可以以多线程的方式操作。</p><p>在第一章中，我们详细地谈到了关于 JavaScript 如何是单线程的。那仍然是成立的。但是单线程不是组织你程序运行的唯一方法。</p><p>想象将你的程序分割成两块儿，在 UI 主线程上运行其中的一块儿，而在一个完全分离的线程上运行另一块儿。</p><p>这样的结构会引发什么我们需要关心的问题？</p><p>其一，你会想知道运行在一个分离的线程上是否意味着它在并行运行（在多 CPU/内核的系统上），如此在第二个线程上长时间运行的处理将 <strong>不会</strong> 阻塞主程序线程。否则，“虚拟线程”所带来的好处，不会比我们已经在异步并发的 JS 中得到的更多。</p><p>而且你会想知道这两块儿程序是否访问共享的作用域/资源。如果是，那么你就要对付多线程语言（Java，C++等等）的所有问题，比如协作式或抢占式锁定（互斥，等）。这是很多额外的工作，而且不应当轻易着手。</p><p>换一个角度，如果这两块儿程序不能共享作用域/资源，你会想知道它们将如何“通信”。</p><p>所有这些我们需要考虑的问题，指引我们探索一个在近 HTML5 时代被加入 web 平台的特性，称为“Web Worker”。这是一个浏览器（也就是宿主环境）特性，而且几乎和 JS 语言本身没有任何关系。也就是说，JavaScript <em>当前</em> 并没有任何特性可以支持多线程运行。</p><p>但是一个像你的浏览器那样的环境可以很容易地提供多个 JavaScript 引擎实例，每个都在自己的线程上，并允许你在每个线程上运行不同的程序。你的程序中分离的线程块儿中的每一个都称为一个“（Web）Worker”。这种并行机制叫做“任务并行机制”，它强调将你的程序分割成块儿来并行运行。</p><p>在你的主 JS 程序（或另一个 Worker）中，你可以这样初始化一个 Worker：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> w1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">&quot;http://some.url.1/mycoolworker.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这个 URL 应当指向 JS 文件的位置（不是一个 HTML 网页！），它将会被加载到一个 Worker。然后浏览器会启动一个分离的线程，让这个文件在这个线程上作为独立的程序运行。</p><p><strong>注意：</strong> 这种用这样的 URL 创建的 Worker 称为“专用（Dedicated）Wroker”。但与提供一个外部文件的 URL 不同的是，你也可以通过提供一个 Blob URL（另一个 HTML5 特性）来创建一个“内联（Inline）Worker”；它实质上是一个存储在单一（二进制）值中的内联文件。但是，Blob 超出了我们要在这里讨论的范围。</p><p>Worker 不会相互，或者与主程序共享任何作用域或资源——那会将所有的多线程编程的噩梦带到我们面前——取而代之的是一种连接它们的基本事件消息机制。</p><p><code>w1</code>Worker 对象是一个事件监听器和触发器，它允许你监听 Worker 发出的事件也允许你向 Worker 发送事件。</p><p>这是如何监听事件（实际上，是固定的<code>&quot;message&quot;</code>事件）：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>w1<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// evt.data</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而且你可以发送<code>&quot;message&quot;</code>事件给 Worker：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>w1<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;something cool to say&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在 Worker 内部，消息是完全对称的：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// &quot;mycoolworker.js&quot;</span>

<span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// evt.data</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;a really cool reply&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>要注意的是，一个专用 Worker 与它创建的程序是一对一的关系。也就是，<code>&quot;message&quot;</code>事件不需要消除任何歧义，因为我们可以确定它只可能来自于这种一对一关系——不是从 Wroker 来的，就是从主页面来的。</p><p>通常主页面的程序会创建 Worker，但是一个 Worker 可以根据需要初始化它自己的子 Worker——称为 subworker。有时将这样的细节委托给一个“主”Worker 十分有用，它可以生成其他 Worker 来处理任务的一部分。不幸的是，在本书写作的时候，Chrome 还没有支持 subworker，然而 Firefox 支持。</p><p>要从创建一个 Worker 的程序中立即杀死它，可以在 Worker 对象（就像前一个代码段中的<code>w1</code>）上调用<code>terminate()</code>。突然终结一个 Worker 线程不会给它任何机会结束它的工作，或清理任何资源。这和你关闭浏览器的标签页来杀死一个页面相似。</p><p>如果你在浏览器中有两个或多个页面（或者打开同一个页面的多个标签页！），试着从同一个文件 URL 中创建 Worker，实际上最终结果是完全分离的 Worker。待一会儿我们就会讨论“共享”Worker 的方法。</p><p><strong>注意：</strong> 看起来一个恶意的或者是呆头呆脑的 JS 程序可以很容易地通过在系统上生成数百个 Worker 来发起拒绝服务攻击（Dos 攻击），看起来每个 Worker 都在自己的线程上。虽然一个 Worker 将会在存在于一个分离的线程上是有某种保证的，但这种保证不是没有限制的。系统可以自由决定有多少实际的线程/CPU/内核要去创建。没有办法预测或保证你能访问多少，虽然很多人假定它至少和可用的 CPU/内核数一样多。我认为最安全的臆测是，除了主 UI 线程外至少有一个线程，仅此而已。</p><h3 id="worker-环境" tabindex="-1"><a class="header-anchor" href="#worker-环境" aria-hidden="true">#</a> Worker 环境</h3><p>在 Worker 内部，你不能访问主程序的任何资源。这意味着你不能访问它的任何全局变量，你也不能访问页面的 DOM 或其他资源。记住：它是一个完全分离的线程。</p><p>然而，你可以实施网络操作（Ajax，WebSocket）和设置定时器。另外，Worker 可以访问它自己的几个重要全局变量/特性的拷贝，包括<code>navigator</code>，<code>location</code>，<code>JSON</code>，和<code>applicationCache</code>。</p><p>你还可以使用<code>importScripts(..)</code>加载额外的 JS 脚本到你的 Worker 中：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 在Worker内部</span>
<span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">&quot;foo.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这些脚本会被同步地加载，这意味着在文件完成加载和运行之前，<code>importScripts(..)</code>调用会阻塞 Worker 的执行。</p><p><strong>注意：</strong> 还有一些关于暴露<code>&lt;canvas&gt;</code>API 给 Worker 的讨论，其中包括使 canvas 成为 Transferable 的（见“数据传送”一节），这将允许 Worker 来实施一些精细的脱线程图形处理，在高性能的游戏（WebGL）和其他类似应用中可能很有用。虽然这在任何浏览器中都还不存在，但是很有可能在近未来发生。</p><p>Web Worker 的常见用途是什么？</p><ul><li>处理密集型的数学计算</li><li>大数据集合的排序</li><li>数据操作（压缩，音频分析，图像像素操作等等）</li><li>高流量网络通信</li></ul><h3 id="数据传送" tabindex="-1"><a class="header-anchor" href="#数据传送" aria-hidden="true">#</a> 数据传送</h3><p>你可能注意到了这些用途中的大多数的一个共同性质，就是它们要求使用事件机制穿越线程间的壁垒来传递大量的信息，也许是双向的。</p><p>在 Worker 的早期，将所有数据序列化为字符串是唯一的选择。除了在两个方向上进行序列化时速度上变慢了，另外一个主要缺点是，数据是被拷贝的，这意味着内存用量翻了一倍（以及在后续垃圾回收上的流失）。</p><p>谢天谢地，现在我们有了几个更好的选择。</p><p>如果你传递一个对象，在另一端一个所谓的“结构化克隆算法（Structured Cloning Algorithm）”（https://developer.mozilla.org/en-US/docs/Web/Guide/API/DOM/The_structured_clone_algorithm ）会用于拷贝/复制这个对象。这个算法相当精巧，甚至可以处理带有循环引用的对象复制。to-string/from-string 的性能劣化没有了，但用这种方式我们依然面对着内存用量的翻倍。IE10 以上版本，和其他主流浏览器都对此有支持。</p><p>一个更好的选择，特别是对大的数据集合而言，是“Transferable 对象”（http://updates.html5rocks.com/2011/12/Transferable-Objects-Lightning-Fast ）。它使对象的“所有权”被传送，而对象本身没动。一旦你传送一个对象给 Worker，它在原来的位置就空了出来或者不可访问——这消除了共享作用域的多线程编程中的灾难。当然，所有权的传送可以双向进行。</p><p>选择使用 Transferable 对象不需要你做太多；任何实现了 Transferable 接口（https://developer.mozilla.org/en-US/docs/Web/API/Transferable ）的数据结构都将自动地以这种方式传递（Firefox 和 Chrome 支持此特性）。</p><p>举个例子，有类型的数组如<code>Uint8Array</code>（见本系列的 <em>ES6 与未来</em>）是一个“Transferables”。这是你如何用<code>postMessage(..)</code>来传送一个 Transferable 对象：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// `foo` 是一个 `Uint8Array`</span>

<span class="token function">postMessage</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> <span class="token punctuation">[</span>foo<span class="token punctuation">.</span>buffer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第一个参数是未经加工的缓冲，而第二个参数是要传送的内容的列表。</p><p>不支持 Transferable 对象的浏览器简单地降级到结构化克隆，这意味着性能上的降低，而不是彻底的特性失灵。</p><h3 id="共享的-workers" tabindex="-1"><a class="header-anchor" href="#共享的-workers" aria-hidden="true">#</a> 共享的 Workers</h3><p>如果你的网站或应用允许多个标签页加载同一个网页（一个常见的特性），你也许非常想通过防止复制专用 Worker 来降低系统资源的使用量；这方面最常见的资源限制是网络套接字链接，因为浏览器限制同时连接到一个服务器的连接数量。当然，限制从客户端来的链接数也缓和了你的服务器资源需求。</p><p>在这种情况下，创建一个单独的中心化 Worker，让你的网站或应用的所有网页实例可以 <em>共享</em> 它是十分有用的。</p><p>这称为<code>SharedWorker</code>，你会这样创建它（仅有 Firefox 与 Chrome 支持此特性）：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> w1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">&quot;http://some.url.1/mycoolworker.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>因为一个共享 Worker 可以连接或被连接到你的网站上的多个程序实例或网页，Worker 需要一个方法来知道消息来自哪个程序。这种唯一的标识称为“端口（port）”——联想网络套接字端口。所以调用端程序必须使用 Worker 的<code>port</code>对象来通信：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>w1<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> handleMessages<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ..</span>

w1<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;something cool&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>另外，端口连接必须被初始化，就像这样：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>w1<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在共享 Worker 内部，一个额外的事件必须被处理：<code>&quot;connect&quot;</code>。这个事件为这个特定的连接提供端口<code>object</code>。保持多个分离的连接最简单的方法是在<code>port</code>上使用闭包，就像下面展示的那样，同时在<code>&quot;connect&quot;</code>事件的处理器内部定义这个连接的事件监听与传送：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 在共享Worker的内部</span>
<span class="token function">addEventListener</span><span class="token punctuation">(</span> <span class="token string">&quot;connect&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// 为这个连接分配的端口</span>
	<span class="token keyword">var</span> port <span class="token operator">=</span> evt<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	port<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span> <span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// ..</span>

		port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// ..</span>
	<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 初始化端口连接</span>
	port<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>除了这点不同，共享与专用 Worker 的功能和语义是一样的。</p><p><strong>注意：</strong> 如果在一个端口的连接终结时还有其他端口的连接存活着的话，共享 Worker 也会存活下来，而专用 Worker 会在与初始化它的程序间接终结时终结。</p><h3 id="填补-web-workers" tabindex="-1"><a class="header-anchor" href="#填补-web-workers" aria-hidden="true">#</a> 填补 Web Workers</h3><p>对于并行运行的 JS 程序在性能考量上，Web Worker 十分吸引人。然而，你的代码可能运行在对此缺乏支持的老版本浏览器上。因为 Worker 是一个 API 而不是语法，所以在某种程度上它们可以被填补。</p><p>如果浏览器不支持 Worker，那就根本没有办法从性能的角度来模拟多线程。Iframe 通常被认为可以提供并行环境，但在所有的现代浏览器中它们实际上和主页运行在同一个线程上，所以用它们来模拟并行机制是不够的。</p><p>正如我们在第一章中详细讨论的，JS 的异步能力（不是并行机制）来自于事件轮询队列，所以你可以用计时器（<code>setTimeout(..)</code>等等）来强制模拟的 Worker 是异步的。然后你只需要提供 Worker API 的填补就行了。这里有一份列表（https://github.com/Modernizr/Modernizr/wiki/HTML5-Cross-Browser-Polyfills#web-workers ），但坦白地说它们看起来都不怎么样。</p><p>我在这里（ https://gist.github.com/getify/1b26accb1a09aa53ad25 ）写了一个填补<code>Worker</code>的轮廓。它很基础，但应该满足了简单的<code>Worker</code>支持，它的双向信息传递可以正确工作，还有<code>&quot;onerror&quot;</code>处理。你可能会扩展它来支持更多特性，比如<code>terminate()</code>或模拟共享 Worker，只要你觉得合适。</p><p><strong>注意：</strong> 你不能模拟同步阻塞，所以这个填补不允许使用<code>importScripts(..)</code>。另一个选择可能是转换并传递 Worker 的代码（一旦 Ajax 加载后），来重写一个<code>importScripts(..)</code>填补的一些异步形式，也许使用一个 promise 相关的接口。</p><h2 id="simd" tabindex="-1"><a class="header-anchor" href="#simd" aria-hidden="true">#</a> SIMD</h2><p>一个指令，多个数据（SIMD）是一种“数据并行机制”形式，与 Web Worker 的“任务并行机制”相对应，因为他强调的不是程序逻辑的块儿被并行化，而是多个字节的数据被并行地处理。</p><p>使用 SIMD，线程不提供并行机制。相反，现代 CPU 用数字的“向量”提供 SIMD 能力——想想：指定类型的数组——还有可以在所有这些数字上并行操作的指令；这些是利用底层操作的指令级别的并行机制。</p><p>使 SIMD 能力包含在 JavaScript 中的努力主要是由 Intel 带头的（https://01.org/node/1495 ），名义上是 Mohammad Haghighat（在本书写作的时候），与 Firefox 和 Chrome 团队合作。SIMD 处于早期标准化阶段，而且很有可能被加入未来版本的 JavaScript 中，很可能在 ES7 的时间框架内。</p><p>SIMD JavaScript 提议向 JS 代码暴露短向量类型与 API，它们在 SIMD 可用的系统中将操作直接映射为 CPU 指令的等价物，同时在非 SIMD 系统中退回到非并行化操作的“shim”。</p><p>对于数据密集型的应用程序（信号分析，对图形的矩阵操作等等）来说，这种并行数学处理在性能上的优势是十分明显的！</p><p>在本书写作时，SIMD API 的早期提案形式看起来像这样：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> v1 <span class="token operator">=</span> <span class="token constant">SIMD</span><span class="token punctuation">.</span><span class="token function">float32x4</span><span class="token punctuation">(</span><span class="token number">3.14159</span><span class="token punctuation">,</span> <span class="token number">21.0</span><span class="token punctuation">,</span> <span class="token number">32.3</span><span class="token punctuation">,</span> <span class="token number">55.55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> v2 <span class="token operator">=</span> <span class="token constant">SIMD</span><span class="token punctuation">.</span><span class="token function">float32x4</span><span class="token punctuation">(</span><span class="token number">2.1</span><span class="token punctuation">,</span> <span class="token number">3.2</span><span class="token punctuation">,</span> <span class="token number">4.3</span><span class="token punctuation">,</span> <span class="token number">5.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> v3 <span class="token operator">=</span> <span class="token constant">SIMD</span><span class="token punctuation">.</span><span class="token function">int32x4</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">1001</span><span class="token punctuation">,</span> <span class="token number">10001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> v4 <span class="token operator">=</span> <span class="token constant">SIMD</span><span class="token punctuation">.</span><span class="token function">int32x4</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">SIMD</span><span class="token punctuation">.</span>float32x4<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 6.597339, 67.2, 138.89, 299.97 ]</span>
<span class="token constant">SIMD</span><span class="token punctuation">.</span>int32x4<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 20, 121, 1031, 10041 ]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里展示了两种不同的向量数据类型，32 位浮点数和 32 位整数。你可以看到这些向量正好被设置为 4 个 32 位元素，这与大多数 CPU 中可用的 SIMD 向量的大小（128 位）相匹配。在未来我们看到一个<code>x8</code>（或更大！）版本的这些 API 也是可能的。</p><p>除了<code>mul()</code>和<code>add()</code>，许多其他操作也很可能被加入，比如<code>sub()</code>，<code>div()</code>，<code>abs()</code>，<code>neg()</code>，<code>sqrt()</code>，<code>reciprocal()</code>，<code>reciprocalSqrt()</code> （算数运算），<code>shuffle()</code>（重拍向量元素），<code>and()</code>，<code>or()</code>，<code>xor()</code>，<code>not()</code>（逻辑运算），<code>equal()</code>，<code>greaterThan()</code>，<code>lessThan()</code> （比较运算），<code>shiftLeft()</code>，<code>shiftRightLogical()</code>，<code>shiftRightArithmetic()</code>（轮换），<code>fromFloat32x4()</code>，和<code>fromInt32x4()</code>（变换）。</p><p><strong>注意：</strong> 这里有一个 SIMD 功能的官方“填补”（很有希望，预期的，着眼未来的填补）（https://github.com/johnmccutchan/ecmascript_simd ），它描述了许多比我们在这一节中没有讲到的许多计划中的 SIMD 功能。</p><h2 id="asm-js" tabindex="-1"><a class="header-anchor" href="#asm-js" aria-hidden="true">#</a> asm.js</h2><p>“asm.js”（http://asmjs.org/ ）是可以被高度优化的 JavaScript 语言子集的标志。通过小心地回避那些特定的很难优化的（垃圾回收，强制转换，等等）机制和模式，asm.js 风格的代码可以被 JS 引擎识别，而且用主动地底层优化进行特殊的处理。</p><p>与本章中讨论的其他性能优化机制不同的是，asm.js 没必须要是必须被 JS 语言规范所采纳的东西。确实有一个 asm.js 规范（http://asmjs.org/spec/latest/ ），但它主要是追踪一组关于优化的候选对象的推论，而不是 JS 引擎的需求。</p><p>目前还没有新的语法被提案。取而代之的是，ams.js 建议了一些方法，用来识别那些符合 ams.js 规则的既存标准 JS 语法，并且让引擎相应地实现它们自己的优化功能。</p><p>关于 ams.js 应当如何在程序中活动的问题，在浏览器生产商之间存在一些争议。早期版本的 asm.js 实验中，要求一个<code>&quot;use asm&quot;;</code>编译附注（与 strict 模式的<code>&quot;use strict&quot;;</code>类似）来帮助 JS 引擎来寻找 asm.js 优化的机会和提示。另一些人则断言 asm.js 应当只是一组启发式算法，让引擎自动地识别而不用作者做任何额外的事情，这意味着理论上既存的程序可以在不用做任何特殊的事情的情况下从 asm.js 优化中获益。</p><h3 id="如何使用-asm-js-进行优化" tabindex="-1"><a class="header-anchor" href="#如何使用-asm-js-进行优化" aria-hidden="true">#</a> 如何使用 asm.js 进行优化</h3><p>关于 asm.js 需要理解的第一件事情是类型和强制转换。如果 JS 引擎不得不在变量的操作期间一直追踪一个变量内的值的类型，以便于在必要时它可以处理强制转换，那么就会有许多额外的工作使程序处于次优化状态。</p><p><strong>注意：</strong> 为了说明的目的，我们将在这里使用 ams.js 风格的代码，但要意识到的是你手写这些代码的情况不是很常见。asm.js 的本意更多的是作为其他工具的编译目标，比如 Emscripten（https://github.com/kripken/emscripten/wiki ）。当然你写自己的 asm.js 代码也是可能的，但是这通常不是一个好主意，因为那样的代码非常底层，而这意味着它会非常耗时而且易错。尽管如此，也会有情况使你想要为了 ams.js 优化的目的手动调整代码。</p><p>这里有一些“技巧”，你可以使用它们来提示支持 asm.js 的 JS 引擎变量/操作预期的类型是什么，以便于它可以跳过那些强制转换追踪的步骤。</p><p>举个例子：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

<span class="token comment">// ..</span>

<span class="token keyword">var</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这个程序中，赋值<code>b = a</code>在变量中留下了类型分歧的问题。然而，它可以写成这样：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

<span class="token comment">// ..</span>

<span class="token keyword">var</span> b <span class="token operator">=</span> a <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里，我们与值<code>0</code>一起使用了<code>|</code>（“二进制或”），虽然它对值没有任何影响，但它确保这个值是一个 32 位整数。这段代码在普通的 JS 引擎中可以工作，但是当它运行在支持 asm.js 的 JS 引擎上时，它 <em>可以</em> 表示<code>b</code>应当总是被作为 32 位整数来对待，所以强制转换追踪可以被跳过。</p><p>类似地，两个变量之间的加法操作可以被限定为性能更好的整数加法（而不是浮点数）：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>再一次，支持 asm.js 的 JS 引擎可以看到这个提示，并推断<code>+</code>操作应当是一个 32 位整数加法，因为不论怎样整个表达式的最终结果都将自动是 32 位整数。</p><h3 id="asm-js-模块" tabindex="-1"><a class="header-anchor" href="#asm-js-模块" aria-hidden="true">#</a> asm.js 模块</h3><p>在 JS 中最托性能后腿的东西之一是关于内存分配，垃圾回收，与作用域访问。asm.js 对于这些问题建一个的一个方法是，声明一个更加正式的 asm.js“模块”——不要和 ES6 模块搞混；参见本系列的 <em>ES6 与未来</em>。</p><p>对于一个 asm.js 模块，你需要明确传入一个被严格遵循的名称空间——在规范中以<code>stdlib</code>引用，因为它应当代表需要的标准库——来引入需要的符号，而不是通过词法作用域来使用全局对象。在最基本的情况下，<code>window</code>对象就是一个可接受的用于 asm.js 模块的<code>stdlib</code>对象，但是你可能应该构建一个更加被严格限制的对象。</p><p>你还必须定义一个“堆（heap）”——这只是一个别致的词汇，它表示在内存中被保留的位置，变量不必要求内存分配或释放已使用内存就可以使用——并将它传入，这样 asm.js 模块就不必做任何导致内存流失的的事情；它可以使用提前保留的空间。</p><p>一个“堆”就像一个有类型的<code>ArrayBuffer</code>，比如：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> heap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">0x10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 64k 的堆</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>使用这个提前保留的 64k 的二进制空间，一个 asm.js 模块可以在这个缓冲区中存储或读取值，而不受任何内存分配与垃圾回收的性能损耗。比如，<code>heap</code>缓冲区可以在模块内部用于备份一个 64 位浮点数值的数组，像这样：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>好了，让我制作一个 asm.js 风格模块的快速，愚蠢的例子来描述这些东西是如何联系在一起的。我们将定义一个<code>foo(..)</code>，它为一个范围接收一个开始位置（<code>x</code>）和一个终止位置（<code>y</code>），并且计算这个范围内所有相邻的数字的积，然后最终计算这些值的平均值：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">fooASM</span><span class="token punctuation">(</span><span class="token parameter">stdlib<span class="token punctuation">,</span> foreign<span class="token punctuation">,</span> heap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;use asm&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">stdlib<span class="token punctuation">.</span>Int32Array</span><span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    x <span class="token operator">=</span> x <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
    y <span class="token operator">=</span> y <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>x <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 计算范围内所有相邻的数字的积</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> x <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>i <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span>y <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> p <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 存储结果</span>
      arr<span class="token punctuation">[</span>p <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 计算所有中间值的平均值</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>
      i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">(</span>i <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span>count <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      p <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sum <span class="token operator">=</span> <span class="token punctuation">(</span>sum <span class="token operator">+</span> arr<span class="token punctuation">[</span>p <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">+</span><span class="token punctuation">(</span>sum <span class="token operator">/</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">foo</span><span class="token operator">:</span> foo<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> heap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token function">fooASM</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> heap<span class="token punctuation">)</span><span class="token punctuation">.</span>foo<span class="token punctuation">;</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 233</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意：</strong> 这个 asm.js 例子是为了演示的目的手动编写的，所以它与那些支持 asm.js 的编译工具生产的代码的表现不同。但是它展示了 asm.js 代码的典型性质，特别是类型提示与为了临时变量存储而使用<code>heap</code>缓冲。</p><p>第一个<code>fooASM(..)</code>调用用它的<code>heap</code>分配区建立了我们的 asm.js 模块。结果是一个我们可以调用任意多次的<code>foo(..)</code>函数。这些调用应当会被支持 asm.js 的 JS 引擎特别优化。重要的是，前面的代码完全是标准 JS，而且会在非 asm.js 引擎中工作的很好（但没有特别优化）。</p><p>很明显，使 asm.js 代码可优化的各种限制降低了广泛使用这种代码的可能性。对于任意给出的 JS 程序，asm.js 没有必要为成为一个一般化的优化集合。相反，它的本意是提供针对一种处理特定任务——如密集数学操作（那些用于游戏中图形处理的）——的优化方法。</p><h2 id="复习" tabindex="-1"><a class="header-anchor" href="#复习" aria-hidden="true">#</a> 复习</h2><p>本书的前四章基于这样的前提：异步编码模式给了你编写更高效代码的能力，这通常是一个非常重要的改进。但是异步行为也就能帮你这么多，因为它在基础上仍然使用一个单独的事件轮询线程。</p><p>所以在这一章我们涵盖了几种程序级别的机制来进一步提升性能。</p><p>Web Worker 让你在一个分离的线程上运行一个 JS 文件（也就是程序），使用异步事件在线程之间传递消息。对于将长时间运行或资源密集型任务挂载到一个不同线程，从而让主 UI 线程保持相应来说，它们非常棒。</p><p>SIMD 提议将 CPU 级别的并行数学操作映射到 JavaScript API 上来提供高性能数据并行操作，比如在大数据集合上进行数字处理。</p><p>最后，asm.js 描述了一个 JavaScript 的小的子集，它回避了 JS 中不易优化的部分（比如垃圾回收与强制转换）并让 JS 引擎通过主动优化识别并运行这样的代码。asm.js 可以手动编写，但是极其麻烦且易错，就像手动编写汇编语言。相反，asm.js 的主要意图是作为一个从其他高度优化的程序语言交叉编译来的目标——例如，Emscripten（https://github.com/kripken/emscripten/wiki ）可以将 C/C++转译为 JavaScript。</p><p>虽然在本章没有明确地提及，在很早以前的有关 JavaScript 的讨论中存在着更激进的想法，包括近似地直接多线程功能（不仅仅是隐藏在数据结构 API 后面）。无论这是否会明确地发生，还是我们将看到更多并行机制偷偷潜入 JS，但是在 JS 中发生更多程序级别优化的未来是可以确定的。</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 1453300745@qq.com">wangtao</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.10857eea.js" defer></script>
  </body>
</html>
