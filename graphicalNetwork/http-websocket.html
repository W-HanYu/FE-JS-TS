<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>既然有 HTTP 协议，为什么还要有 WebSocket？ | </title><meta name="description" content="">
    <link rel="modulepreload" href="/assets/app.6b14d0e7.js"><link rel="modulepreload" href="/assets/http-websocket.html.83a115d8.js"><link rel="modulepreload" href="/assets/http-websocket.html.e22dec73.js"><link rel="prefetch" href="/assets/1.1.hello-world.html.8479520f.js"><link rel="prefetch" href="/assets/1.10.if.html.ee9844c1.js"><link rel="prefetch" href="/assets/1.11.includes.html.9fd66ad0.js"><link rel="prefetch" href="/assets/1.12.parameters.html.78b9f978.js"><link rel="prefetch" href="/assets/1.13.push.html.dff6a084.js"><link rel="prefetch" href="/assets/1.14.unshift.html.e2cfd721.js"><link rel="prefetch" href="/assets/1.2.Pick.html.f507eb3c.js"><link rel="prefetch" href="/assets/1.3.Awaited.html.eec902ce.js"><link rel="prefetch" href="/assets/1.4.Readonly.html.976f5ef4.js"><link rel="prefetch" href="/assets/1.5.Tuple-to-object.html.ec9d02b0.js"><link rel="prefetch" href="/assets/1.6.First-of-array.html.066cc960.js"><link rel="prefetch" href="/assets/1.7.Length-of-Tuple.html.33b52969.js"><link rel="prefetch" href="/assets/1.8.concat.html.89a4039b.js"><link rel="prefetch" href="/assets/1.9.exclude.html.ad3d794b.js"><link rel="prefetch" href="/assets/2.1.Get-Return-Type.html.12fba697.js"><link rel="prefetch" href="/assets/2.2.omit.html.83757496.js"><link rel="prefetch" href="/assets/2.3.Readonly2.html.99cac86e.js"><link rel="prefetch" href="/assets/2.4.Deep-Readonly.html.2e3dc401.js"><link rel="prefetch" href="/assets/2.5.turn-to-union.html.21a1ab09.js"><link rel="prefetch" href="/assets/3.1.Simple-Vue.html.dfc69c1d.js"><link rel="prefetch" href="/assets/basic-1.html.2034d087.js"><link rel="prefetch" href="/assets/basic-2.html.4b6e94fb.js"><link rel="prefetch" href="/assets/basic-3.html.945b5f7d.js"><link rel="prefetch" href="/assets/http-2.html.7e775dfb.js"><link rel="prefetch" href="/assets/http-3.html.f61fbf53.js"><link rel="prefetch" href="/assets/http-interview.html.715cb4de.js"><link rel="prefetch" href="/assets/http-optimize.html.0a6cc392.js"><link rel="prefetch" href="/assets/http-rpc.html.3e2e1cf8.js"><link rel="prefetch" href="/assets/https-ecdhe.html.a996bfd0.js"><link rel="prefetch" href="/assets/https-optimize.html.ec562b67.js"><link rel="prefetch" href="/assets/https-rsa.html.e1bcc62c.js"><link rel="prefetch" href="/assets/ip-base.html.a93d05df.js"><link rel="prefetch" href="/assets/ip-ping.html.3c73dd54.js"><link rel="prefetch" href="/assets/ip-ping_io.html.712d2ecf.js"><link rel="prefetch" href="/assets/tcp-challenge-ack.html.4455d08f.js"><link rel="prefetch" href="/assets/tcp-dump.html.f61fd796.js"><link rel="prefetch" href="/assets/tcp-feature.html.bcd928c9.js"><link rel="prefetch" href="/assets/tcp-interview.html.e29cf7aa.js"><link rel="prefetch" href="/assets/tcp-isn-deff.html.27f9f772.js"><link rel="prefetch" href="/assets/tcp-optimize.html.df1c45f6.js"><link rel="prefetch" href="/assets/tcp-out-of-order-fin.html.7ea17895.js"><link rel="prefetch" href="/assets/tcp-queue.html.fe4847f2.js"><link rel="prefetch" href="/assets/tcp-stream.html.b2b42bd2.js"><link rel="prefetch" href="/assets/tcp-syn.html.4c4f2e46.js"><link rel="prefetch" href="/assets/donate.html.a699149d.js"><link rel="prefetch" href="/assets/Routine1_pattern-matching-for-extraction.html.277192f0.js"><link rel="prefetch" href="/assets/Advanced-1.html.1d55fb49.js"><link rel="prefetch" href="/assets/Advanced-2.html.0f67efb5.js"><link rel="prefetch" href="/assets/Advanced-3.html.bd370497.js"><link rel="prefetch" href="/assets/Advanced-4.html.488faaf6.js"><link rel="prefetch" href="/assets/Advanced-5.html.0509684e.js"><link rel="prefetch" href="/assets/Extended-article-1.html.4e02f8d4.js"><link rel="prefetch" href="/assets/base-1.html.ae57c9e9.js"><link rel="prefetch" href="/assets/base-10.html.5d368511.js"><link rel="prefetch" href="/assets/base-11.html.52bc2140.js"><link rel="prefetch" href="/assets/base-12.html.aecc4ac9.js"><link rel="prefetch" href="/assets/base-13.html.49f51e68.js"><link rel="prefetch" href="/assets/base-14.html.b694ac57.js"><link rel="prefetch" href="/assets/base-15.html.b7e9dabd.js"><link rel="prefetch" href="/assets/base-16.html.7772a2e4.js"><link rel="prefetch" href="/assets/base-17.html.6f1ccef3.js"><link rel="prefetch" href="/assets/base-2.html.a4d2c09b.js"><link rel="prefetch" href="/assets/base-3.html.01779845.js"><link rel="prefetch" href="/assets/base-4.html.2655e65b.js"><link rel="prefetch" href="/assets/base-5.html.49062e7e.js"><link rel="prefetch" href="/assets/base-6.html.fc330ec3.js"><link rel="prefetch" href="/assets/base-7.html.5f360a1f.js"><link rel="prefetch" href="/assets/base-8.html.6fee7962.js"><link rel="prefetch" href="/assets/base-9.html.6cc4dc51.js"><link rel="prefetch" href="/assets/rollup-1.html.33a06741.js"><link rel="prefetch" href="/assets/rollup-10.html.a654be3e.js"><link rel="prefetch" href="/assets/rollup-11.html.0f71f8bd.js"><link rel="prefetch" href="/assets/rollup-2.html.914f4a24.js"><link rel="prefetch" href="/assets/rollup-3.html.c38fb60d.js"><link rel="prefetch" href="/assets/rollup-4.html.6f699503.js"><link rel="prefetch" href="/assets/rollup-5.html.7f6e550f.js"><link rel="prefetch" href="/assets/rollup-6.html.3b12ca4e.js"><link rel="prefetch" href="/assets/rollup-7.html.1713c81a.js"><link rel="prefetch" href="/assets/rollup-8.html.f227ba3d.js"><link rel="prefetch" href="/assets/rollup-9.html.2099ab83.js"><link rel="prefetch" href="/assets/scope-closures-appA.html.dd831119.js"><link rel="prefetch" href="/assets/scope-closures-appB.html.064bbcb3.js"><link rel="prefetch" href="/assets/scope-closures-appC.html.0095d517.js"><link rel="prefetch" href="/assets/this-object-prototype-appA.html.fa55a2a8.js"><link rel="prefetch" href="/assets/async-performance-apA.html.50ddef6c.js"><link rel="prefetch" href="/assets/async-performance-apB.html.25126b63.js"><link rel="prefetch" href="/assets/async-performance-ch1.html.95353f88.js"><link rel="prefetch" href="/assets/async-performance-ch2.html.08d8937b.js"><link rel="prefetch" href="/assets/async-performance-ch3.html.ce60f009.js"><link rel="prefetch" href="/assets/async-performance-ch4.html.67f937eb.js"><link rel="prefetch" href="/assets/async-performance-ch5.html.2f592c57.js"><link rel="prefetch" href="/assets/async-performance-ch6.html.57d5d7c1.js"><link rel="prefetch" href="/assets/types-grammar-1.html.cad720bd.js"><link rel="prefetch" href="/assets/types-grammar-2.html.731328bf.js"><link rel="prefetch" href="/assets/types-grammar-3.html.144e07ba.js"><link rel="prefetch" href="/assets/types-grammar-4.html.adc2ab3f.js"><link rel="prefetch" href="/assets/types-grammar-5.html.2808b449.js"><link rel="prefetch" href="/assets/types-grammar-apA.html.a2bb939c.js"><link rel="prefetch" href="/assets/404.html.d2dc3323.js"><link rel="prefetch" href="/assets/1.1.hello-world.html.2c9af279.js"><link rel="prefetch" href="/assets/1.10.if.html.0bd6f98d.js"><link rel="prefetch" href="/assets/1.11.includes.html.b6371e7a.js"><link rel="prefetch" href="/assets/1.12.parameters.html.8f586a6e.js"><link rel="prefetch" href="/assets/1.13.push.html.fc54eab3.js"><link rel="prefetch" href="/assets/1.14.unshift.html.ba736c63.js"><link rel="prefetch" href="/assets/1.2.Pick.html.5eb2d846.js"><link rel="prefetch" href="/assets/1.3.Awaited.html.7b9416d9.js"><link rel="prefetch" href="/assets/1.4.Readonly.html.fc1d479a.js"><link rel="prefetch" href="/assets/1.5.Tuple-to-object.html.3caa1b7f.js"><link rel="prefetch" href="/assets/1.6.First-of-array.html.1b173b16.js"><link rel="prefetch" href="/assets/1.7.Length-of-Tuple.html.7ecba7f0.js"><link rel="prefetch" href="/assets/1.8.concat.html.af196ae6.js"><link rel="prefetch" href="/assets/1.9.exclude.html.f6d3bb66.js"><link rel="prefetch" href="/assets/2.1.Get-Return-Type.html.38001e5f.js"><link rel="prefetch" href="/assets/2.2.omit.html.bdade769.js"><link rel="prefetch" href="/assets/2.3.Readonly2.html.7d6876ce.js"><link rel="prefetch" href="/assets/2.4.Deep-Readonly.html.00b75d1a.js"><link rel="prefetch" href="/assets/2.5.turn-to-union.html.9ead4235.js"><link rel="prefetch" href="/assets/3.1.Simple-Vue.html.505d0933.js"><link rel="prefetch" href="/assets/basic-1.html.bd5ea478.js"><link rel="prefetch" href="/assets/basic-2.html.a8879cb1.js"><link rel="prefetch" href="/assets/basic-3.html.ea675ea7.js"><link rel="prefetch" href="/assets/http-2.html.c2c82fb3.js"><link rel="prefetch" href="/assets/http-3.html.48bbf367.js"><link rel="prefetch" href="/assets/http-interview.html.b5a1a417.js"><link rel="prefetch" href="/assets/http-optimize.html.1ab5dc52.js"><link rel="prefetch" href="/assets/http-rpc.html.4d4ca1cc.js"><link rel="prefetch" href="/assets/https-ecdhe.html.f52aed70.js"><link rel="prefetch" href="/assets/https-optimize.html.f9125377.js"><link rel="prefetch" href="/assets/https-rsa.html.98f110b5.js"><link rel="prefetch" href="/assets/ip-base.html.742f581e.js"><link rel="prefetch" href="/assets/ip-ping.html.808ef9a8.js"><link rel="prefetch" href="/assets/ip-ping_io.html.b6dae97a.js"><link rel="prefetch" href="/assets/tcp-challenge-ack.html.311aa1dc.js"><link rel="prefetch" href="/assets/tcp-dump.html.9a2b75c8.js"><link rel="prefetch" href="/assets/tcp-feature.html.e0024e59.js"><link rel="prefetch" href="/assets/tcp-interview.html.068fc997.js"><link rel="prefetch" href="/assets/tcp-isn-deff.html.9022bb66.js"><link rel="prefetch" href="/assets/tcp-optimize.html.ac8f55cc.js"><link rel="prefetch" href="/assets/tcp-out-of-order-fin.html.3be10e80.js"><link rel="prefetch" href="/assets/tcp-queue.html.ca1f141c.js"><link rel="prefetch" href="/assets/tcp-stream.html.95df489a.js"><link rel="prefetch" href="/assets/tcp-syn.html.f86931f3.js"><link rel="prefetch" href="/assets/donate.html.1593471c.js"><link rel="prefetch" href="/assets/Routine1_pattern-matching-for-extraction.html.4cc22c63.js"><link rel="prefetch" href="/assets/Advanced-1.html.2cd64583.js"><link rel="prefetch" href="/assets/Advanced-2.html.90fa5804.js"><link rel="prefetch" href="/assets/Advanced-3.html.5c102b3a.js"><link rel="prefetch" href="/assets/Advanced-4.html.91b2f2c2.js"><link rel="prefetch" href="/assets/Advanced-5.html.51c0d77e.js"><link rel="prefetch" href="/assets/Extended-article-1.html.69f1cba9.js"><link rel="prefetch" href="/assets/base-1.html.0655662d.js"><link rel="prefetch" href="/assets/base-10.html.81027dfe.js"><link rel="prefetch" href="/assets/base-11.html.dfda6635.js"><link rel="prefetch" href="/assets/base-12.html.f6f6b398.js"><link rel="prefetch" href="/assets/base-13.html.30c82439.js"><link rel="prefetch" href="/assets/base-14.html.1c4f40f5.js"><link rel="prefetch" href="/assets/base-15.html.4193ebd5.js"><link rel="prefetch" href="/assets/base-16.html.664a6708.js"><link rel="prefetch" href="/assets/base-17.html.1f26d880.js"><link rel="prefetch" href="/assets/base-2.html.ebaf56b7.js"><link rel="prefetch" href="/assets/base-3.html.55ccc796.js"><link rel="prefetch" href="/assets/base-4.html.28001ddb.js"><link rel="prefetch" href="/assets/base-5.html.a66fc56c.js"><link rel="prefetch" href="/assets/base-6.html.670ee6b7.js"><link rel="prefetch" href="/assets/base-7.html.b7ecb78e.js"><link rel="prefetch" href="/assets/base-8.html.35d167b1.js"><link rel="prefetch" href="/assets/base-9.html.a7508a7f.js"><link rel="prefetch" href="/assets/rollup-1.html.ddc5c2b1.js"><link rel="prefetch" href="/assets/rollup-10.html.71d41057.js"><link rel="prefetch" href="/assets/rollup-11.html.abd73cd4.js"><link rel="prefetch" href="/assets/rollup-2.html.fc5179de.js"><link rel="prefetch" href="/assets/rollup-3.html.5cb6590d.js"><link rel="prefetch" href="/assets/rollup-4.html.19058640.js"><link rel="prefetch" href="/assets/rollup-5.html.b60ff9d2.js"><link rel="prefetch" href="/assets/rollup-6.html.dba509c6.js"><link rel="prefetch" href="/assets/rollup-7.html.78083656.js"><link rel="prefetch" href="/assets/rollup-8.html.da31dce9.js"><link rel="prefetch" href="/assets/rollup-9.html.0698cc06.js"><link rel="prefetch" href="/assets/scope-closures-appA.html.243bb2a3.js"><link rel="prefetch" href="/assets/scope-closures-appB.html.faf48320.js"><link rel="prefetch" href="/assets/scope-closures-appC.html.1eed8854.js"><link rel="prefetch" href="/assets/this-object-prototype-appA.html.97c8616e.js"><link rel="prefetch" href="/assets/async-performance-apA.html.d914cf07.js"><link rel="prefetch" href="/assets/async-performance-apB.html.ff3695f4.js"><link rel="prefetch" href="/assets/async-performance-ch1.html.d4b49db8.js"><link rel="prefetch" href="/assets/async-performance-ch2.html.3088ad28.js"><link rel="prefetch" href="/assets/async-performance-ch3.html.96802924.js"><link rel="prefetch" href="/assets/async-performance-ch4.html.6fbd0d72.js"><link rel="prefetch" href="/assets/async-performance-ch5.html.b4fa724a.js"><link rel="prefetch" href="/assets/async-performance-ch6.html.58fc0726.js"><link rel="prefetch" href="/assets/types-grammar-1.html.38f1859a.js"><link rel="prefetch" href="/assets/types-grammar-2.html.5971be4a.js"><link rel="prefetch" href="/assets/types-grammar-3.html.56b75088.js"><link rel="prefetch" href="/assets/types-grammar-4.html.0eabc2c7.js"><link rel="prefetch" href="/assets/types-grammar-5.html.350c82a2.js"><link rel="prefetch" href="/assets/types-grammar-apA.html.f787fc68.js"><link rel="prefetch" href="/assets/404.html.8cc69e3d.js">
    <link rel="stylesheet" href="/assets/style.f4d22aab.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><!--v-if--></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">既然有 HTTP 协议，为什么还要有 WebSocket？ <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/graphicalNetwork/http-websocket.html#使用-http-不断轮询" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 HTTP 不断轮询"><!--[--><!--]--> 使用 HTTP 不断轮询 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/graphicalNetwork/http-websocket.html#长轮询" class="router-link-active router-link-exact-active sidebar-item" aria-label="长轮询"><!--[--><!--]--> 长轮询 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/graphicalNetwork/http-websocket.html#websocket是什么" class="router-link-active router-link-exact-active sidebar-item" aria-label="WebSocket是什么"><!--[--><!--]--> WebSocket是什么 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/graphicalNetwork/http-websocket.html#怎么建立websocket连接" class="router-link-active router-link-exact-active sidebar-item" aria-label="怎么建立WebSocket连接"><!--[--><!--]--> 怎么建立WebSocket连接 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/graphicalNetwork/http-websocket.html#websocket抓包" class="router-link-active router-link-exact-active sidebar-item" aria-label="WebSocket抓包"><!--[--><!--]--> WebSocket抓包 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/graphicalNetwork/http-websocket.html#websocket的消息格式" class="router-link-active router-link-exact-active sidebar-item" aria-label="WebSocket的消息格式"><!--[--><!--]--> WebSocket的消息格式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/graphicalNetwork/http-websocket.html#websocket的使用场景" class="router-link-active router-link-exact-active sidebar-item" aria-label="WebSocket的使用场景"><!--[--><!--]--> WebSocket的使用场景 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/graphicalNetwork/http-websocket.html#总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="既然有-http-协议-为什么还要有-websocket" tabindex="-1"><a class="header-anchor" href="#既然有-http-协议-为什么还要有-websocket" aria-hidden="true">#</a> 既然有 HTTP 协议，为什么还要有 WebSocket？</h1><p><strong>求知，好学，勤奋</strong>，这些刻在你 DNA 里的东西都动起来了。</p><p>你点开后发现。</p><p>长相平平无奇的古某提示你&quot;道士 9 条狗，全服横着走&quot;。</p><p>影帝某辉老师跟你说&quot;系兄弟就来砍我&quot;。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/b8cca4b1291f25235bc8df3dddbb6da3.png" alt="图片"></p><p>来都来了，你就选了个角色进到了游戏界面里。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/95e5b4cee384b182d0e604378c3ca00a.jpeg" alt="图片"></p><p>这时候，上来就是一个小怪，从远处走来，然后疯狂拿木棒子抽你。</p><p><strong>你全程没点任何一次鼠标</strong>。服务器就自动将怪物的移动数据和攻击数据源源不断发给你了。</p><p>这….太暖心了。</p><p>感动之余，问题就来了，</p><p>像这种<strong>看起来服务器主动发消息给客户端的场景</strong>，是怎么做到的？</p><p>在真正回答这个问题之前，我们先来聊下一些相关的知识背景。</p><h2 id="使用-http-不断轮询" tabindex="-1"><a class="header-anchor" href="#使用-http-不断轮询" aria-hidden="true">#</a> 使用 HTTP 不断轮询</h2><p>其实问题的痛点在于，<strong>怎么样才能在用户不做任何操作的情况下，网页能收到消息并发生变更。</strong></p><p>最常见的解决方案是，<strong>网页的前端代码里不断定时发 HTTP 请求到服务器，服务器收到请求后给客户端响应消息。</strong></p><p>这其实时一种「<strong>伪</strong>」服务器推的形式。</p><p>它其实并不是服务器主动发消息到客户端，而是客户端自己不断偷偷请求服务器，只是用户无感知而已。</p><p>用这种方式的场景也有很多，最常见的就是<strong>扫码登录</strong>。</p><p>比如，某信公众号平台，登录页面二维码出现之后，<strong>前端</strong>网页根本不知道用户扫没扫，于是不断去向<strong>后端</strong>服务器询问，看有没有人扫过这个码。而且是以大概 1 到 2 秒的间隔去不断发出请求，这样可以保证用户在扫码后能在 1 到 2 秒内得到及时的反馈，不至于<strong>等太久</strong>。</p><p>使用HTTP定时轮询</p><p>但这样，会有两个比较明显的问题：</p><ul><li>当你打开 F12 页面时，你会发现满屏的 HTTP 请求。虽然很小，但这其实也消耗带宽，同时也会增加下游服务器的负担。</li><li>最坏情况下，用户在扫码后，需要等个 1~2 秒，正好才触发下一次 HTTP 请求，然后才跳转页面，用户会感到<strong>明显的卡顿</strong>。</li></ul><p>使用起来的体验就是，二维码出现后，手机扫一扫，然后在手机上点个确认，这时候<strong>卡顿等个 1~2 秒</strong>，页面才跳转。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/5e0e0e25e8aca80812c9a2892032111c.png" alt="图片"></p><p>那么问题又来了，<strong>有没有更好的解决方案？</strong></p><p>有，而且实现起来成本还非常低。</p><h2 id="长轮询" tabindex="-1"><a class="header-anchor" href="#长轮询" aria-hidden="true">#</a> 长轮询</h2><p>我们知道，HTTP 请求发出后，一般会给服务器留一定的时间做响应，比如 3 秒，规定时间内没返回，就认为是超时。</p><p>如果我们的 HTTP 请求<strong>将超时设置的很大</strong>，比如 30 秒，<strong>在这 30 秒内只要服务器收到了扫码请求，就立马返回给客户端网页。如果超时，那就立马发起下一次请求。</strong></p><p>这样就减少了 HTTP 请求的个数，并且由于大部分情况下，用户都会在某个 30 秒的区间内做扫码操作，所以响应也是及时的。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/1058a96ba35215c0f30accc3ff5bb824.png" alt="图片"></p><p>比如，某度云网盘就是这么干的。所以你会发现一扫码，手机上点个确认，电脑端网页就<strong>秒跳转</strong>，体验很好。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/a3a8c95b97d2bac26cfab123a4da68b2.png" alt="图片"></p><p>像这种发起一个请求，在较长时间内等待服务器响应的机制，就是所谓的<strong>长轮询机制</strong>。我们常用的消息队列 RocketMQ 中，消费者去取数据时，也用到了这种方式。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/6173c1d25abc914ef17ee9e534ed6a5f.png" alt="图片"></p><p>像这种，在用户不感知的情况下，服务器将数据推送给浏览器的技术，就是所谓的<strong>服务器推送</strong>技术，它还有个毫不沾边的英文名，<strong>comet</strong> 技术，大家听过就好。</p><p>上面提到的两种解决方案（不断轮询和长轮询），本质上，其实还是客户端主动去取数据。</p><p>对于像扫码登录这样的<strong>简单场景</strong>还能用用。但如果是网页游戏呢，游戏一般会有大量的数据需要从服务器主动推送到客户端。</p><p>这就得说下 <strong>WebSocket</strong> 了。</p><h2 id="websocket是什么" tabindex="-1"><a class="header-anchor" href="#websocket是什么" aria-hidden="true">#</a> WebSocket是什么</h2><p>我们知道 TCP 连接的两端，<strong>同一时间里</strong>，<strong>双方</strong>都可以<strong>主动</strong>向对方发送数据。这就是所谓的<strong>全双工</strong>。</p><p>而现在使用最广泛的<code>HTTP/1.1</code>，也是基于TCP协议的，<strong>同一时间里</strong>，客户端和服务器<strong>只能有一方主动</strong>发数据，这就是所谓的<strong>半双工</strong>。</p><p>也就是说，好好的全双工 TCP，被 HTTP/1.1 用成了半双工。</p><p>为什么？</p><p>这是由于 HTTP 协议设计之初，考虑的是看看网页文本的场景，能做到<strong>客户端发起请求再由服务器响应</strong>，就够了，根本就没考虑网页游戏这种，客户端和服务器之间都要互相主动发大量数据的场景。</p><p>所以，为了更好的支持这样的场景，我们需要另外一个<strong>基于TCP的新协议</strong>。</p><p>于是新的应用层协议<strong>WebSocket</strong>就被设计出来了。</p><p>大家别被这个名字给带偏了。虽然名字带了个socket，但其实 <strong>socket 和 WebSocket 之间，就跟雷峰和雷峰塔一样，二者接近毫无关系</strong>。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/3bbe4c5db972513f912d30ba8cbddd65.png" alt="图片"></p><h3 id="怎么建立websocket连接" tabindex="-1"><a class="header-anchor" href="#怎么建立websocket连接" aria-hidden="true">#</a> 怎么建立WebSocket连接</h3><p>我们平时刷网页，一般都是在浏览器上刷的，一会刷刷图文，这时候用的是 <strong>HTTP 协议</strong>，一会打开网页游戏，这时候就得切换成我们新介绍的 <strong>WebSocket 协议</strong>。</p><p>为了兼容这些使用场景。浏览器在 <strong>TCP 三次握手</strong>建立连接之后，都<strong>统一使用 HTTP 协议</strong>先进行一次通信。</p><ul><li>如果此时是<strong>普通的 HTTP 请求</strong>，那后续双方就还是老样子继续用普通 HTTP 协议进行交互，这点没啥疑问。</li><li>如果这时候是<strong>想建立 WebSocket 连接</strong>，就会在 HTTP 请求里带上一些<strong>特殊的header 头</strong>，如下：</li></ul><div class="language-http ext-http line-numbers-mode"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">Upgrade</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade</span><span class="token punctuation">:</span> <span class="token header-value">WebSocket</span></span>
<span class="token header"><span class="token header-name keyword">Sec-WebSocket-Key</span><span class="token punctuation">:</span> <span class="token header-value">T2a6wZlAwhgQNqruZ2YUyg==\r\n</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这些 header 头的意思是，浏览器想<strong>升级协议（Connection: Upgrade）</strong>，并且<strong>想升级成 WebSocket 协议（Upgrade: WebSocket）</strong>。同时带上一段<strong>随机生成的 base64 码（Sec-WebSocket-Key）</strong>，发给服务器。</p><p>如果服务器正好支持升级成 WebSocket 协议。就会走 WebSocket 握手流程，同时根据客户端生成的 base64 码，用某个<strong>公开的</strong>算法变成另一段字符串，放在 HTTP 响应的 <code>Sec-WebSocket-Accept</code> 头里，同时带上<code>101状态码</code>，发回给浏览器。HTTP 的响应如下：</p><div class="language-http ext-http line-numbers-mode"><pre class="language-http"><code><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">101</span> <span class="token reason-phrase string">Switching Protocols\r\n</span></span>
<span class="token header"><span class="token header-name keyword">Sec-WebSocket-Accept</span><span class="token punctuation">:</span> <span class="token header-value">iBJKv/ALIW2DobfoA4dmr3JHBCY=\r\n</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade</span><span class="token punctuation">:</span> <span class="token header-value">WebSocket\r\n</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">Upgrade\r\n</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>HTTP 状态码=200（正常响应）的情况，大家见得多了。101 确实不常见，它其实是指<strong>协议切换</strong>。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/dea71991b336c876cae2e1ebdf03b62d.png" alt="图片"></p><p>之后，浏览器也用同样的<strong>公开算法</strong>将<code>base64码</code>转成另一段字符串，如果这段字符串跟服务器传回来的<strong>字符串一致</strong>，那验证通过。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/117eebe06cc6b35ded3216a95706f080.png" alt="图片"></p><p>就这样经历了一来一回两次 HTTP 握手，WebSocket就建立完成了，后续双方就可以使用 webscoket 的数据格式进行通信了。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/f4edd3018914fe6eb38fad6aa3fd2d65.png" alt="图片"></p><h3 id="websocket抓包" tabindex="-1"><a class="header-anchor" href="#websocket抓包" aria-hidden="true">#</a> WebSocket抓包</h3><p>我们可以用wireshark抓个包，实际看下数据包的情况。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/f756ca625523f0f9d40a402465179bbe.png" alt="图片"></p><p>上面这张图，注意画了红框的第<code>2445</code>行报文，是WebSocket的<strong>第一次握手</strong>，意思是发起了一次带有<code>特殊Header</code>的HTTP请求。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/82d65f08dad05e6b537ea06b94224a5f.png" alt="图片"></p><p>上面这个图里画了红框的<code>4714</code>行报文，就是服务器在得到第一次握手后，响应的<strong>第二次握手</strong>，可以看到这也是个 HTTP 类型的报文，返回的状态码是 101。同时可以看到返回的报文 header 中也带有各种<code>WebSocket</code>相关的信息，比如<code>Sec-WebSocket-Accept</code>。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/382c7699530ea7e7b22f60bb68af21bd.png" alt="图片"></p><p>上面这张图就是全貌了，从截图上的注释可以看出，WebSocket和HTTP一样都是基于TCP的协议。<strong>经历了三次TCP握手之后，利用 HTTP 协议升级为 WebSocket 协议</strong>。</p><p>你在网上可能会看到一种说法：&quot;WebSocket 是基于HTTP的新协议&quot;，<strong>其实这并不对</strong>，因为WebSocket只有在建立连接时才用到了HTTP，<strong>升级完成之后就跟HTTP没有任何关系了</strong>。</p><p>这就好像你喜欢的女生通过你要到了你大学室友的微信，然后他们自己就聊起来了。你能说这个女生是通过你去跟你室友沟通的吗？不能。你跟HTTP一样，都只是个<strong>工具人</strong>。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/2e9d4b1652bdfa1e3ae4bb24f70a1b5a.png" alt="图片"></p><p>这就有点&quot;<strong>借壳生蛋</strong>&quot;的那意思。</p><p>HTTP和WebSocket的关系</p><h3 id="websocket的消息格式" tabindex="-1"><a class="header-anchor" href="#websocket的消息格式" aria-hidden="true">#</a> WebSocket的消息格式</h3><p>上面提到在完成协议升级之后，两端就会用webscoket的数据格式进行通信。</p><p>数据包在WebSocket中被叫做<strong>帧</strong>，我们来看下它的数据格式长什么样子。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/3a63a86e5d7e72a37b9828fc6e65c21f.png" alt="图片"></p><p>这里面字段很多，但我们只需要关注下面这几个。</p><p><strong>opcode字段</strong>：这个是用来标志这是个<strong>什么类型</strong>的数据帧。比如。</p><ul><li>等于 1 ，是指text类型（<code>string</code>）的数据包</li><li>等于 2 ，是二进制数据类型（<code>[]byte</code>）的数据包</li><li>等于 8 ，是关闭连接的信号</li></ul><p><strong>payload字段</strong>：存放的是我们<strong>真正想要传输的数据的长度</strong>，单位是<strong>字节</strong>。比如你要发送的数据是<code>字符串&quot;111&quot;</code>，那它的长度就是<code>3</code>。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/437a076935f82be1d36960c9a4785fbd.png" alt="图片"></p><p>另外，可以看到，我们存放<strong>payload 长度的字段有好几个</strong>，我们既可以用最前面的<code>7bit</code>, 也可以用后面的<code>7+16bit 或 7+64bit。</code></p><p>那么问题就来了。</p><p>我们知道，在数据层面，大家都是 01 二进制流。我怎么知道<strong>什么情况下应该读 7 bit，什么情况下应该读7+16bit呢？</strong></p><p>WebSocket会用最开始的7bit做标志位。不管接下来的数据有多大，都<strong>先读最先的7个bit</strong>，根据它的取值决定还要不要再读个 16bit 或 64bit。</p><ul><li>如果<code>最开始的7bit</code>的值是 0~125，那么它就表示了 <strong>payload 全部长度</strong>，只读最开始的<code>7个bit</code>就完事了。</li></ul><p><img src="https://img-blog.csdnimg.cn/img_convert/690f5a4deda2de50f3a35eddf0be4d75.png" alt="图片"></p><ul><li>如果是<code>126（0x7E）</code>。那它表示payload的长度范围在 <code>126~65535</code> 之间，接下来还需要<strong>再读16bit</strong>。这16bit会包含payload的真实长度。</li></ul><p><img src="https://img-blog.csdnimg.cn/img_convert/c815c9dabc02fceb42a98c762705af33.png" alt="图片"></p><ul><li>如果是<code>127（0x7F）</code>。那它表示payload的长度范围<code>&gt;=65536</code>，接下来还需要<strong>再读64bit</strong>。这64bit会包含payload的长度。这能放2的64次方byte的数据，换算一下好多个TB，肯定够用了。</li></ul><p><img src="https://img-blog.csdnimg.cn/img_convert/192b22b4fe46e8dfb7b17549306d5998.png" alt="图片"></p><p><strong>payload data字段</strong>：这里存放的就是真正要传输的数据，在知道了上面的payload长度后，就可以根据这个值去截取对应的数据。</p><p>大家有没有发现一个小细节，WebSocket的数据格式也是<strong>数据头（内含payload长度） + payload data</strong> 的形式。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/d449242f1bf41c6f95a5314ec8311d0d.jpeg" alt="图片"></p><p>这是因为 TCP 协议本身就是全双工，但直接使用<strong>纯裸TCP</strong>去传输数据，会有<strong>粘包</strong>的&quot;问题&quot;。为了解决这个问题，上层协议一般会用<strong>消息头+消息体</strong>的格式去重新包装要发的数据。</p><p>而<strong>消息头</strong>里一般含有<strong>消息体的长度</strong>，通过这个长度可以去截取真正的消息体。</p><p>HTTP 协议和大部分 RPC 协议，以及我们今天介绍的WebSocket协议，都是这样设计的。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/b91fedb1856897c231b8fb5932b7b2d2.png" alt="图片"></p><h3 id="websocket的使用场景" tabindex="-1"><a class="header-anchor" href="#websocket的使用场景" aria-hidden="true">#</a> WebSocket的使用场景</h3><p>WebSocket完美继承了 TCP 协议的<strong>全双工</strong>能力，并且还贴心的提供了解决粘包的方案。</p><p>它适用于<strong>需要服务器和客户端（浏览器）频繁交互</strong>的大部分场景，比如网页/小程序游戏，网页聊天室，以及一些类似飞书这样的网页协同办公软件。</p><p>回到文章开头的问题，在使用 WebSocket 协议的网页游戏里，怪物移动以及攻击玩家的行为是<strong>服务器逻辑</strong>产生的，对玩家产生的伤害等数据，都需要由<strong>服务器主动发送给客户端</strong>，客户端获得数据后展示对应的效果。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/31410d2e885aab55c2c588aad754bb5c.png" alt="图片"></p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><ul><li>TCP 协议本身是<strong>全双工</strong>的，但我们最常用的 HTTP/1.1，虽然是基于 TCP 的协议，但它是<strong>半双工</strong>的，对于大部分需要服务器主动推送数据到客户端的场景，都不太友好，因此我们需要使用支持全双工的 WebSocket 协议。</li><li>在 HTTP/1.1 里，只要客户端不问，服务端就不答。基于这样的特点，对于登录页面这样的简单场景，可以使用<strong>定时轮询或者长轮询</strong>的方式实现<strong>服务器推送</strong>(comet)的效果。</li><li>对于客户端和服务端之间需要频繁交互的复杂场景，比如网页游戏，都可以考虑使用 WebSocket 协议。</li><li>WebSocket 和 socket 几乎没有任何关系，只是叫法相似。</li><li>正因为各个浏览器都支持 HTTP协 议，所以 WebSocket 会先利用HTTP协议加上一些特殊的 header 头进行握手升级操作，升级成功后就跟 HTTP 没有任何关系了，之后就用 WebSocket 的数据格式进行收发数据。</li></ul><hr></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 1453300745@qq.com">wangtao</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.6b14d0e7.js" defer></script>
  </body>
</html>
